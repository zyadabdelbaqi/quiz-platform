<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الكويزات التعليمية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Amiri', serif;
        }
        #studentInfoForm {
            max-width: 600px;
            margin: 0 auto;
        }
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .student-mode { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .teacher-mode { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- صفحة المعلم -->
    <div id="teacherPage" class="hidden">
        <div class="teacher-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-graduation-cap mr-3"></i>منصة كويزات MET
                </h1>
                <p class="text-center text-lg opacity-90">UserID: <span id="userIdDisplay"></span></p>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-plus-circle text-blue-500 mr-2"></i>إنشاء / تعديل كويز
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">عنوان الكويز</label>
                        <input type="text" id="quizTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="أدخل عنوان الكويز">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">وصف الكويز</label>
                        <input type="text" id="quizDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="وصف مختصر للكويز">
                    </div>
                </div>

                <div id="questionsContainer" class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>
                </div>

                <div class="flex gap-4 mb-6 flex-wrap">
                    <button onclick="addQuestion('multiple')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-list mr-2"></i>إضافة سؤال اختيار متعدد
                    </button>
                    <button onclick="addQuestion('boolean')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-check-circle mr-2"></i>إضافة سؤال صح/خطأ
                    </button>
                    <button onclick="addQuestion('text')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-edit mr-2"></i>إضافة سؤال نصي
                    </button>
                </div>

                <button id="saveQuizBtn" onclick="saveQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-save mr-2"></i>حفظ الكويز
                </button>
                <button onclick="clearQuizForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg ml-2">
                    <i class="fas fa-eraser mr-2"></i>مسح النموذج
                </button>
                 <input type="hidden" id="editQuizId">
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-list text-green-500 mr-2"></i>الكويزات المحفوظة
                </h2>
                <div id="savedQuizzes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                     <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة الطالب -->
    <div id="studentPage" class="hidden">
        <div class="student-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-user-graduate mr-3"></i>صفحة الطالب
                </h1>
                <p class="text-center text-lg opacity-90">أجب على الأسئلة بعناية</p>
            </div>
        </div>
        <div class="quiz-container px-4 py-8">
            <div id="studentInfoForm" class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">بيانات الطالب</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">اسم الطالب</label>
                    <input type="text" id="studentName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="أدخل اسمك الكامل">
                </div>
                <button onclick="startQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-play mr-2"></i>بدء الاختبار
                </button>
            </div>
            <div id="quizContent" class="bg-white rounded-lg shadow-lg p-6 hidden">
                 <div class="loader"></div>
            </div>
        </div>
    </div>
    
    <!-- صفحة النتائج -->
    <div id="resultsPage" class="hidden">
        <div class="student-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-chart-bar mr-3"></i>نتائج الكويز
                </h1>
            </div>
        </div>
        <div class="quiz-container px-4 py-8">
            <div id="resultsContent" class="bg-white rounded-lg shadow-lg p-6">
                 <div class="loader"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let questions = [];
        let currentQuiz = null;
        let studentAnswers = {};
        let userId = null;
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
                document.getElementById('userIdDisplay').textContent = userId;
                initializeAppLogic();
            } else {
                console.log("User is not signed in. Attempting to sign in.");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                    document.body.innerHTML = "<h1>Error: Could not authenticate. Please refresh the page.</h1>";
                }
            }
        });

        // --- INITIALIZATION ---
        function initializeAppLogic() {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            const resultsForStudent = urlParams.get('results');
            const studentAttemptId = urlParams.get('attempt');

            if (resultsForStudent && quizId && studentAttemptId) {
                showResultsForStudent(quizId, studentAttemptId);
            } else if (quizId) {
                loadQuizForStudent(quizId);
            } else {
                showTeacherPage();
            }
        }
        
        // Expose functions to global scope
        window.addQuestion = addQuestion;
        window.removeQuestion = removeQuestion;
        window.saveQuiz = saveQuiz;
        window.clearQuizForm = clearQuizForm;
        window.copyQuizLink = copyQuizLink;
        window.viewQuizResults = viewQuizResults;
        window.editQuiz = editQuiz;
        window.deleteQuiz = deleteQuiz;
        window.startQuiz = startQuiz;
        window.submitStudentQuiz = submitStudentQuiz;
        window.closeStatsModal = closeStatsModal;


        // --- UI VISIBILITY ---
        function showTeacherPage() {
            document.getElementById('teacherPage').classList.remove('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            loadSavedQuizzes();
        }

        function showStudentPage() {
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
        }

        function showResultsPage() {
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
        }

        // --- TEACHER: QUIZ CREATION ---
        function addQuestion(type, questionData = {}) {
            const questionId = questionData.id || Date.now();
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4';
            questionDiv.id = `question-${questionId}`;

            const questionIndex = questions.length;

            let questionHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-700">سؤال ${questionIndex + 1}</h4>
                    <button onclick="removeQuestion('${questionId}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <input type="text" placeholder="نص السؤال" class="question-text w-full p-3 border border-gray-300 rounded-lg mb-3" value="${questionData.text || ''}" required>
                <!-- Image upload is disabled for this version to simplify backend integration -->
            `;

            if (type === 'multiple') {
                questionHTML += `
                    <div class="options-container">
                        ${[0, 1, 2, 3].map(i => `
                            <div class="mb-2">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct-${questionId}" value="${i}" class="correct-answer" ${(questionData.correctAnswer !== undefined && questionData.correctAnswer === i) ? 'checked' : ''}>
                                    <input type="text" placeholder="خيار ${i + 1}" class="option-text flex-1 p-2 border border-gray-300 rounded" value="${(questionData.options && questionData.options[i]) || ''}">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">اختر الإجابة الصحيحة</p>
                    <textarea placeholder="هامش توضيحي (اختياري)" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'boolean') {
                questionHTML += `
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="true" class="correct-answer ml-2" ${questionData.correctAnswer === true ? 'checked' : ''}> صحيح
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="false" class="correct-answer ml-2" ${questionData.correctAnswer === false ? 'checked' : ''}> خطأ
                        </label>
                    </div>
                    <textarea placeholder="هامش توضيحي (اختياري)" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'text') {
                questionHTML += `<input type="text" placeholder="الإجابة الصحيحة" class="correct-text w-full p-3 border border-gray-300 rounded-lg" value="${questionData.correctAnswer || ''}">`;
            }

            questionDiv.innerHTML = questionHTML;
            document.getElementById('questionsContainer').appendChild(questionDiv);

            if (!questions.find(q => q.id === questionId)) {
                questions.push({ id: questionId, type: type });
            }
        }
        
        function removeQuestion(questionId) {
            document.getElementById(`question-${questionId}`).remove();
            questions = questions.filter(q => q.id != questionId);
        }

        async function saveQuiz() {
            document.getElementById('saveQuizBtn').disabled = true;
            const title = document.getElementById('quizTitle').value;
            const description = document.getElementById('quizDescription').value;
            const editQuizId = document.getElementById('editQuizId').value;

            if (!title.trim()) {
                showMessageBox('يرجى إدخال عنوان الكويز');
                document.getElementById('saveQuizBtn').disabled = false;
                return;
            }
            if (questions.length === 0) {
                showMessageBox('يرجى إضافة سؤال واحد على الأقل');
                document.getElementById('saveQuizBtn').disabled = false;
                return;
            }
            
            const quizData = {
                title: title,
                description: description,
                creatorId: userId,
                createdAt: serverTimestamp(),
                questions: [],
            };

            for (const q of questions) {
                const questionDiv = document.getElementById(`question-${q.id}`);
                const questionText = questionDiv.querySelector('.question-text').value;
                if (!questionText.trim()) {
                    showMessageBox('يرجى ملء جميع نصوص الأسئلة');
                    document.getElementById('saveQuizBtn').disabled = false;
                    return;
                }
                const explanationText = questionDiv.querySelector('.explanation-text') ? questionDiv.querySelector('.explanation-text').value : '';

                const questionData = {
                    id: q.id,
                    text: questionText,
                    type: q.type,
                    explanation: explanationText
                };

                if (q.type === 'multiple') {
                    const options = Array.from(questionDiv.querySelectorAll('.option-text')).map(input => input.value);
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    if (!correctAnswer || options.some(opt => !opt.trim())) {
                        showMessageBox('يرجى ملء جميع الخيارات واختيار إجابة صحيحة لسؤال الاختيار من متعدد.');
                        document.getElementById('saveQuizBtn').disabled = false;
                        return;
                    }
                    questionData.options = options;
                    questionData.correctAnswer = parseInt(correctAnswer.value);
                } else if (q.type === 'boolean') {
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    if (!correctAnswer) {
                         showMessageBox('يرجى اختيار (صح) أو (خطأ) لجميع أسئلة الصح والخطأ.');
                         document.getElementById('saveQuizBtn').disabled = false;
                         return;
                    }
                    questionData.correctAnswer = correctAnswer.value === 'true';
                } else if (q.type === 'text') {
                    const correctText = questionDiv.querySelector('.correct-text').value;
                    if (!correctText.trim()) {
                        showMessageBox('يرجى إدخال الإجابة الصحيحة للأسئلة النصية.');
                        document.getElementById('saveQuizBtn').disabled = false;
                        return;
                    }
                    questionData.correctAnswer = correctText.trim();
                }
                quizData.questions.push(questionData);
            }

            try {
                const quizId = editQuizId || doc(collection(db, `artifacts/${appId}/public/data/quizzes`)).id;
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                await setDoc(quizRef, quizData, { merge: true }); // Use setDoc with merge for both create and update
                
                showMessageBox('تم حفظ الكويز بنجاح!');
                clearQuizForm();
            } catch (error) {
                console.error("Error saving quiz: ", error);
                showMessageBox('حدث خطأ أثناء حفظ الكويز. يرجى المحاولة مرة أخرى.');
            } finally {
                document.getElementById('saveQuizBtn').disabled = false;
            }
        }
        
        function clearQuizForm() {
            document.getElementById('quizTitle').value = '';
            document.getElementById('quizDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>';
            document.getElementById('editQuizId').value = '';
            questions = [];
        }

        function loadSavedQuizzes() {
            if (!userId) return;
            const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
            const q = query(quizzesRef); // In a real app with many users, you'd add: where("creatorId", "==", userId)
            
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('savedQuizzes');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center col-span-full">لا توجد كويزات محفوظة</p>';
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const quiz = doc.data();
                    const quizId = doc.id;
                    const readableDate = quiz.createdAt ? new Date(quiz.createdAt.seconds * 1000).toLocaleString('ar-EG') : 'غير محدد';
                    return `
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-bold text-lg text-gray-800 mb-2">${quiz.title}</h3>
                            <p class="text-gray-600 mb-2">${quiz.description}</p>
                            <p class="text-sm text-gray-500 mb-3">
                                <i class="fas fa-calendar ml-1"></i>${readableDate} | 
                                <i class="fas fa-question-circle ml-1"></i>${quiz.questions.length} سؤال
                            </p>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="copyQuizLink('${quizId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition"><i class="fas fa-link ml-1"></i>نسخ الرابط</button>
                                <button onclick="viewQuizResults('${quizId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition"><i class="fas fa-chart-bar ml-1"></i>النتائج</button>
                                <button onclick="editQuiz('${quizId}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition"><i class="fas fa-edit ml-1"></i>تعديل</button>
                                <button onclick="deleteQuiz('${quizId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition"><i class="fas fa-trash ml-1"></i>حذف</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }, (error) => {
                console.error("Error loading quizzes: ", error);
                document.getElementById('savedQuizzes').innerHTML = '<p class="text-red-500 text-center col-span-full">فشل تحميل الكويزات.</p>';
            });
        }
        
        async function editQuiz(quizId) {
            try {
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const docSnap = await getDoc(quizRef);
                if (!docSnap.exists()) {
                    showMessageBox('الكويز المراد تعديله غير موجود.');
                    return;
                }
                const quizToEdit = docSnap.data();
                
                document.getElementById('quizTitle').value = quizToEdit.title;
                document.getElementById('quizDescription').value = quizToEdit.description;
                document.getElementById('editQuizId').value = quizId;
                
                document.getElementById('questionsContainer').innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>';
                questions = [];
                
                quizToEdit.questions.forEach(q => addQuestion(q.type, q));
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error("Error fetching quiz for edit:", error);
                showMessageBox('فشل في تحميل الكويز للتعديل.');
            }
        }
        
        function copyQuizLink(quizId) {
            const link = `${window.location.origin}${window.location.pathname}?quiz=${quizId}`;
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessageBox('تم نسخ الرابط! يمكنك مشاركته مع الطلاب');
        }

        function deleteQuiz(quizId) {
            showConfirmBox('هل أنت متأكد من حذف هذا الكويز؟ سيتم حذف جميع نتائجه أيضاً.', async () => {
                try {
                    const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                    await deleteDoc(quizRef);
                    // Note: Deleting subcollections like results needs more complex logic (e.g., a cloud function)
                    // For this app, we'll just delete the quiz document.
                    showMessageBox('تم حذف الكويز بنجاح');
                    loadSavedQuizzes(); // Refresh list
                } catch(error) {
                    console.error("Error deleting quiz:", error);
                    showMessageBox("فشل حذف الكويز.");
                }
            });
        }

        // --- STUDENT: TAKING QUIZ ---
        async function loadQuizForStudent(quizId) {
            showStudentPage();
            try {
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const docSnap = await getDoc(quizRef);

                if (!docSnap.exists()) {
                    document.getElementById('quizContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">الكويز غير موجود</h2>
                            <p class="text-gray-600">الرابط الذي تحاول الوصول إليه غير صحيح أو تم حذف الكويز</p>
                        </div>`;
                    document.getElementById('studentInfoForm').classList.add('hidden');
                    return;
                }
                
                currentQuiz = { id: docSnap.id, ...docSnap.data() };
                document.getElementById('studentInfoForm').classList.remove('hidden');
                document.getElementById('quizContent').classList.add('hidden');
                document.getElementById('quizContent').innerHTML = ''; // Clear loader
            } catch(error) {
                console.error("Error loading quiz for student: ", error);
                 document.getElementById('quizContent').innerHTML = `<p class="text-red-500 text-center">فشل تحميل الكويز. حاول تحديث الصفحة.</p>`;
            }
        }

        function startQuiz() {
            const studentName = document.getElementById('studentName').value;
            if (!studentName.trim()) {
                showMessageBox('يرجى إدخال اسم الطالب');
                return;
            }
            studentAnswers.studentName = studentName;
            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('quizContent').classList.remove('hidden');
            
            const quiz = currentQuiz;
            const quizHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${quiz.title}</h1>
                    <p class="text-gray-600 text-lg">${quiz.description}</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                        <i class="fas fa-info-circle text-blue-500 ml-2"></i> عدد الأسئلة: ${quiz.questions.length}
                    </div>
                </div>
                <form id="studentQuizForm">
                    ${quiz.questions.map((question, index) => {
                        let questionHTML = `
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">${index + 1}</span>
                                    ${question.text}
                                </h3>`;
                        if (question.type === 'multiple') {
                            questionHTML += `<div class="space-y-3">${question.options.map((option, optionIndex) => `
                                <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                    <input type="radio" name="question_${question.id}" value="${optionIndex}" class="ml-3 text-blue-500 focus:ring-blue-500">
                                    <span class="flex-1">${option}</span>
                                </label>`).join('')}</div>`;
                        } else if (question.type === 'boolean') {
                            questionHTML += `<div class="space-y-3">
                                <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                    <input type="radio" name="question_${question.id}" value="true" class="ml-3 text-blue-500 focus:ring-blue-500"><span class="flex-1">صحيح</span>
                                </label>
                                <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                    <input type="radio" name="question_${question.id}" value="false" class="ml-3 text-blue-500 focus:ring-blue-500"><span class="flex-1">خطأ</span>
                                </label></div>`;
                        } else if (question.type === 'text') {
                            questionHTML += `<input type="text" name="question_${question.id}" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg" placeholder="اكتب إجابتك هنا...">`;
                        }
                        questionHTML += '</div>';
                        return questionHTML;
                    }).join('')}
                    <div class="text-center mt-8">
                        <button type="button" onclick="submitStudentQuiz()" class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg transition hover:shadow-lg">
                            <i class="fas fa-paper-plane ml-2"></i> إرسال الإجابات
                        </button>
                    </div>
                </form>
            `;
            document.getElementById('quizContent').innerHTML = quizHTML;
        }

        async function submitStudentQuiz() {
            const form = document.getElementById('studentQuizForm');
            const formData = new FormData(form);
            let allAnswered = true;
            currentQuiz.questions.forEach(question => {
                const answer = formData.get(`question_${question.id}`);
                if (!answer || answer.trim() === '') allAnswered = false;
                studentAnswers[question.id] = answer;
            });
            if (!allAnswered) {
                showMessageBox('يرجى الإجابة على جميع الأسئلة قبل الإرسال');
                return;
            }

            let correctAnswersCount = 0;
            const resultDetails = {
                quizId: currentQuiz.id,
                quizTitle: currentQuiz.title,
                studentName: studentAnswers.studentName,
                totalQuestions: currentQuiz.questions.length,
                submittedAt: serverTimestamp(),
                answers: [],
            };
            
            currentQuiz.questions.forEach(question => {
                const studentAnswer = studentAnswers[question.id];
                let isCorrect = false;
                if (question.type === 'multiple') isCorrect = parseInt(studentAnswer) === question.correctAnswer;
                else if (question.type === 'boolean') isCorrect = (studentAnswer === 'true') === question.correctAnswer;
                else if (question.type === 'text') isCorrect = studentAnswer.trim().toLowerCase() === question.correctAnswer.toLowerCase();
                if (isCorrect) correctAnswersCount++;
                resultDetails.answers.push({
                    questionId: question.id,
                    studentAnswer: studentAnswer,
                    isCorrect: isCorrect
                });
            });
            
            resultDetails.correctAnswers = correctAnswersCount;
            resultDetails.score = Math.round((correctAnswersCount / currentQuiz.questions.length) * 100);

            try {
                const resultsCollectionRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                const resultDocRef = await addDoc(resultsCollectionRef, resultDetails);
                window.location.href = `${window.location.pathname}?quiz=${currentQuiz.id}&results=true&attempt=${resultDocRef.id}`;
            } catch (error) {
                console.error("Error submitting results:", error);
                showMessageBox('فشل في إرسال نتيجتك. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // --- RESULTS VIEW ---
        async function showResultsForStudent(quizId, attemptId) {
            showResultsPage();
            try {
                const resultRef = doc(db, `artifacts/${appId}/public/data/quiz_results`, attemptId);
                const resultSnap = await getDoc(resultRef);
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const quizSnap = await getDoc(quizRef);

                if (!resultSnap.exists() || !quizSnap.exists()) {
                    document.getElementById('resultsContent').innerHTML = `<h2 class="text-center text-red-500">النتيجة أو الكويز غير موجود.</h2>`;
                    return;
                }
                const resultData = resultSnap.data();
                const quizData = quizSnap.data();

                let resultsHTML = `
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">نتيجة الكويز</h1>
                        <h2 class="text-xl text-gray-600 mb-4">${resultData.quizTitle}</h2>
                        <p class="bg-gray-100 p-3 rounded-lg inline-block mb-4"><i class="fas fa-user ml-2"></i>اسم الطالب: ${resultData.studentName}</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><div class="text-2xl font-bold text-blue-600">${resultData.score}%</div><div class="text-sm text-gray-600">النسبة المئوية</div></div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4"><div class="text-2xl font-bold text-green-600">${resultData.correctAnswers}</div><div class="text-sm text-gray-600">إجابات صحيحة</div></div>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4"><div class="text-2xl font-bold text-gray-600">${resultData.totalQuestions}</div><div class="text-sm text-gray-600">إجمالي الأسئلة</div></div>
                        </div>
                    </div>
                    <div class="mb-6"><h3 class="text-2xl font-bold text-gray-800 mb-4">مراجعة الإجابات</h3>
                    ${resultData.answers.map((answer, index) => {
                        const question = quizData.questions.find(q => q.id == answer.questionId);
                        if (!question) return '';
                        let correctAnswerText = '';
                        if (question.type === 'multiple') correctAnswerText = question.options[question.correctAnswer];
                        else if (question.type === 'boolean') correctAnswerText = question.correctAnswer ? 'صحيح' : 'خطأ';
                        else correctAnswerText = question.correctAnswer;
                        let studentAnswerText = answer.studentAnswer;
                        if (question.type === 'multiple') studentAnswerText = question.options[parseInt(answer.studentAnswer)];
                        else if (question.type === 'boolean') studentAnswerText = answer.studentAnswer === 'true' ? 'صحيح' : 'خطأ';
                        
                        return `
                            <div class="bg-gray-50 p-6 rounded-lg border-r-4 ${answer.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4">
                                <h4 class="text-lg font-semibold text-gray-800 mb-3">${index + 1}. ${question.text}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-3 rounded border"><div class="text-sm font-medium text-gray-600 mb-1">إجابتك:</div><div class="text-lg ${answer.isCorrect ? 'text-green-700' : 'text-red-700'}">${studentAnswerText}</div></div>
                                    <div class="bg-white p-3 rounded border"><div class="text-sm font-medium text-gray-600 mb-1">الإجابة الصحيحة:</div><div class="text-lg text-green-700">${correctAnswerText}</div></div>
                                </div>
                                ${question.explanation ? `<div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mt-4"><p class="text-blue-800">${question.explanation}</p></div>` : ''}
                            </div>`;
                    }).join('')}</div>
                    <div class="text-center"><button onclick="window.close()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition"><i class="fas fa-times ml-2"></i>إغلاق النافذة</button></div>`;
                document.getElementById('resultsContent').innerHTML = resultsHTML;

            } catch(error) {
                console.error("Error showing results:", error);
                document.getElementById('resultsContent').innerHTML = `<h2 class="text-center text-red-500">فشل تحميل النتائج.</h2>`;
            }
        }
        
        async function viewQuizResults(quizId) {
            const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
            const q = query(resultsRef, where("quizId", "==", quizId));
            const querySnapshot = await getDocs(q);
            
            const allResults = [];
            querySnapshot.forEach((doc) => allResults.push(doc.data()));
            
            if (allResults.length === 0) {
                showMessageBox('لا توجد نتائج لهذا الكويز بعد');
                return;
            }

            const totalAttempts = allResults.length;
            const avgScore = Math.round(allResults.reduce((sum, result) => sum + result.score, 0) / totalAttempts);
            
            const statsHTML = `
                <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeStatsModal(event)">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">إحصائيات الكويز</h2>
                            <button onclick="document.getElementById('statsModal').remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-2xl"></i></button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-blue-50 border p-4 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${totalAttempts}</div><div class="text-sm">محاولات إجمالية</div></div>
                                <div class="bg-green-50 border p-4 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${avgScore}%</div><div class="text-sm">متوسط الدرجات</div></div>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">جميع المحاولات</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">${allResults.map((result, index) => {
                                const submittedDate = result.submittedAt ? new Date(result.submittedAt.seconds * 1000).toLocaleString('ar-EG') : 'غير محدد';
                                return `<div class="bg-gray-50 p-4 rounded-lg border">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-semibold">${result.studentName}</div>
                                            <div class="text-sm text-gray-600">${submittedDate}</div>
                                        </div>
                                        <div class="text-left">
                                            <div class="text-2xl font-bold ${result.score >= 60 ? 'text-green-600' : 'text-red-600'}">${result.score}%</div>
                                        </div>
                                    </div>
                                </div>`
                            }).join('')}</div>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', statsHTML);
        }

        function closeStatsModal(event) {
            if (event.target.id === "statsModal") {
                document.getElementById('statsModal').remove();
            }
        }

        // --- UTILITIES: MODALS ---
        function showMessageBox(message) {
            const modalId = 'customAlertModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            const modalHTML = `<div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <button onclick="document.getElementById('${modalId}').remove()" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition">حسناً</button>
                    </div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        function showConfirmBox(message, onConfirmCallback) {
             const modalId = 'customConfirmModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            const modalHTML = `<div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition">نعم</button>
                            <button id="confirmNoBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">إلغاء</button>
                        </div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('confirmYesBtn').onclick = () => {
                document.getElementById(modalId).remove();
                if (onConfirmCallback) onConfirmCallback();
            };
            document.getElementById('confirmNoBtn').onclick = () => {
                document.getElementById(modalId).remove();
            };
        }
    </script>
</body>
</html>
