<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كويزات MET</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        /* الأنماط العامة */
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6; /* لون خلفية افتراضي */
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Amiri', serif;
        }
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .student-mode { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .teacher-mode { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #studentInfoForm { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="teacherPage" class="hidden">
        <div class="teacher-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-graduation-cap mr-3"></i>
                    منصة كويزات MET
                </h1>
                <p class="text-center text-lg opacity-90"></p>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-plus-circle text-blue-500 mr-2"></i>
                    إنشاء / تعديل كويز
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">عنوان الكويز</label>
                        <input type="text" id="quizTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="أدخل عنوان الكويز">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">وصف الكويز</label>
                        <input type="text" id="quizDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="وصف مختصر للكويز">
                    </div>
                </div>

                <div id="questionsContainer" class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>
                </div>

                <div class="flex gap-4 mb-6 flex-wrap">
                    <button onclick="addQuestion('multiple')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-list mr-2"></i>إضافة سؤال اختيار متعدد
                    </button>
                    <button onclick="addQuestion('boolean')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-check-circle mr-2"></i>إضافة سؤال صح/خطأ
                    </button>
                    <button onclick="addQuestion('text')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-edit mr-2"></i>إضافة سؤال نصي
                    </button>
                </div>

                <button onclick="saveQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-save mr-2"></i>حفظ الكويز
                </button>
                <button onclick="clearQuizForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg ml-2">
                    <i class="fas fa-eraser mr-2"></i>مسح النموذج
                </button>
                 <input type="hidden" id="editQuizId">
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-list text-green-500 mr-2"></i>
                    الكويزات المحفوظة
                </h2>
                <div id="savedQuizzes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- سيتم تحميل الكويزات المحفوظة هنا -->
                </div>
            </div>
        </div>
    </div>

    <div id="studentPage" class="hidden">
        <div class="student-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-user-graduate mr-3"></i>
                    صفحة الطالب
                </h1>
                <p class="text-center text-lg opacity-90">أجب على الأسئلة بعناية</p>
                <p class="text-center text-sm mt-2">
                     <i class="fas fa-id-badge ml-1"></i> معرف المستخدم: <span id="studentUserId"></span>
                </p>
            </div>
        </div>

        <div class="quiz-container px-4 py-8">
            <div id="studentInfoForm" class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">بيانات الطالب</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">اسم الطالب</label>
                    <input type="text" id="studentName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="أدخل اسمك الكامل">
                </div>
                <button onclick="startQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-play mr-2"></i>بدء الاختبار
                </button>
            </div>
            <div id="quizContent" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <!-- سيتم تحميل محتوى الكويز هنا -->
            </div>
        </div>
    </div>

    <div id="resultsPage" class="hidden">
        <div class="student-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-chart-bar mr-3"></i>
                    نتائج الكويز
                </h1>
            </div>
        </div>

        <div class="quiz-container px-4 py-8">
            <div id="resultsContent" class="bg-white rounded-lg shadow-lg p-6">
                <!-- سيتم تحميل النتائج هنا -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration - Use __firebase_config if provided, else use the user's explicit config
        const firebaseConfig = JSON.parse(
            typeof __firebase_config !== 'undefined' && __firebase_config.length > 2 // Check if it's actually populated
                ? __firebase_config
                : '{"apiKey":"AIzaSyCTyHb79TSlbjwuebsb_Pd8VoqvWHEh-RI","authDomain":"my-quiz-app-77c96.firebaseapp.com","projectId":"my-quiz-app-77c96","storageBucket":"my-quiz-app-77c96.firebasestorage.app","messagingSenderId":"692482795107","appId":"1:692482795107:web:10ad0a80e523dfdaaa3a56"}'
        );

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables for Firebase instances and user ID
        let currentUserId = null;
        let isAuthReady = false; // Flag to ensure auth is ready before Firestore ops

        // Global variables for quiz management
        let questions = [];
        let currentQuiz = null;
        let studentAnswers = {}; // This will hold current answers in session

        // App ID for Firestore paths (from Canvas environment or default)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';

        // localStorage key for saving partial quiz progress
        const QUIZ_PROGRESS_STORAGE_KEY = 'quiz_student_progress';

        // Firebase Authentication Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                // Sign in anonymously if no user is logged in
                try {
                    // Check if __initial_auth_token is provided, otherwise sign in anonymously
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    currentUserId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback for anonymous
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    showMessageBox("حدث خطأ في المصادقة: " + error.message + ". يرجى المحاولة مرة أخرى.");
                }
            }
            isAuthReady = true;
            // Update UI with user ID if visible
            const studentUserIdElement = document.getElementById('studentUserId');
            if (studentUserIdElement) {
                studentUserIdElement.textContent = currentUserId;
            }
            // Once auth is ready, proceed with loading quiz data
            initializePage();
        });

        // Function to initialize the page based on URL parameters
        function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            const resultsParam = urlParams.get('results');
            const studentIdParam = urlParams.get('studentId'); // Passed when showing results on refresh
            const teacherIdParam = urlParams.get('teacher'); // Passed when showing results on refresh

            if (resultsParam && quizId && studentIdParam && teacherIdParam) {
                // If direct link to results page, show results
                window.showResults(quizId, studentIdParam, teacherIdParam);
            } else if (quizId) {
                // If direct link to quiz (student mode), load quiz for student
                window.loadQuizForStudent(quizId, teacherIdParam); // Pass teacherId to load quiz
            } else {
                // Default to teacher page if no specific quiz is requested
                window.showTeacherPage();
            }
        }

        // --- Teacher Functions ---
        window.showTeacherPage = function() { // Made global
            document.getElementById('teacherPage').classList.remove('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            if (isAuthReady) {
                window.loadSavedQuizzes();
            } else {
                // Wait for auth to be ready
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.loadSavedQuizzes();
                        unsubscribe(); // Stop listening after auth is ready
                    }
                });
            }
        }

        window.addQuestion = function(type, questionData = {}) { // Made global
            const questionId = questionData.id || Date.now().toString(); // Use string for ID
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4';
            questionDiv.id = `question-${questionId}`;

            let questionHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-700">سؤال ${questions.length + 1}</h4>
                    <button onclick="removeQuestion('${questionId}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <input type="text" placeholder="نص السؤال" class="question-text w-full p-3 border border-gray-300 rounded-lg mb-3" value="${questionData.text || ''}" required>
                <input type="file" class="question-image-upload w-full p-3 border border-gray-300 rounded-lg mb-3" accept="image/*">
                ${questionData.imageUrl ? `<img src="${questionData.imageUrl}" class="mt-2 mb-3 rounded-lg max-w-full h-auto" alt="صورة السؤال">` : ''}
            `;

            if (type === 'multiple') {
                questionHTML += `
                    <div class="options-container">
                        ${[0, 1, 2, 3].map(i => `
                            <div class="mb-2">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct-${questionId}" value="${i}" class="correct-answer" ${questionData.correctAnswer === i ? 'checked' : ''}>
                                    <input type="text" placeholder="خيار ${i + 1}" class="option-text flex-1 p-2 border border-gray-300 rounded" value="${(questionData.options && questionData.options[i]) || ''}">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">اختر الإجابة الصحيحة</p>
                    <textarea placeholder="هامش توضيحي (اختياري)" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'boolean') {
                questionHTML += `
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="true" class="correct-answer ml-2" ${questionData.correctAnswer === true ? 'checked' : ''}>
                            صح
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="false" class="correct-answer ml-2" ${questionData.correctAnswer === false ? 'checked' : ''}>
                            خطأ
                        </label>
                    </div>
                    <textarea placeholder="هامش توضيحي (اختياري)" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'text') {
                questionHTML += `
                    <input type="text" placeholder="الإجابة الصحيحة" class="correct-text w-full p-3 border border-gray-300 rounded-lg" value="${questionData.correctAnswer || ''}">
                `;
            }

            questionDiv.innerHTML = questionHTML;
            document.getElementById('questionsContainer').appendChild(questionDiv);

            // If it's a new question, push it to the questions array
            if (!questionData.id) {
                questions.push({
                    id: questionId,
                    type: type
                });
            } else {
                // If it's an existing question being re-added (e.g., during edit)
                // Ensure it's in the `questions` array or update it if needed.
                const existingIndex = questions.findIndex(q => q.id === questionId);
                if (existingIndex === -1) {
                    questions.push({
                        id: questionId,
                        type: type
                    });
                } else {
                    questions[existingIndex] = { id: questionId, type: type };
                }
            }
        }

        window.removeQuestion = function(questionId) { // Made global
            document.getElementById(`question-${questionId}`).remove();
            questions = questions.filter(q => q.id != questionId);
        }

        window.saveQuiz = async function() { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox('الرجاء الانتظار حتى يتم تهيئة المصادقة.');
                return;
            }

            const title = document.getElementById('quizTitle').value;
            const description = document.getElementById('quizDescription').value;
            const editQuizId = document.getElementById('editQuizId').value;

            if (!title.trim()) {
                window.showMessageBox('يرجى إدخال عنوان الكويز');
                return;
            }

            if (questions.length === 0) {
                window.showMessageBox('يرجى إضافة سؤال واحد على الأقل');
                return;
            }

            const quiz = {
                title: title,
                description: description,
                questions: [],
                createdAt: new Date().toLocaleString('ar-EG'),
                teacherId: currentUserId // Link quiz to the teacher
            };

            for (const q of questions) {
                const questionDiv = document.getElementById(`question-${q.id}`);
                const questionText = questionDiv.querySelector('.question-text').value;
                const explanationText = questionDiv.querySelector('.explanation-text') ? questionDiv.querySelector('.explanation-text').value : '';
                const imageFile = questionDiv.querySelector('.question-image-upload').files[0];
                let imageUrl = '';

                if (!imageFile) {
                    // If no new image is uploaded, check if there's an existing one from previous save/edit
                    const existingImgElement = questionDiv.querySelector(`img[alt="صورة السؤال"]`);
                    if (existingImgElement) {
                        imageUrl = existingImgElement.src;
                    }
                } else {
                    imageUrl = await window.encodeImageFileAsURL(imageFile);
                }


                const questionData = {
                    id: q.id,
                    text: questionText,
                    type: q.type,
                    explanation: explanationText,
                    imageUrl: imageUrl
                };

                if (!questionText.trim()) {
                    window.showMessageBox('يرجى ملء جميع الأسئلة');
                    return;
                }


                if (q.type === 'multiple') {
                    const options = Array.from(questionDiv.querySelectorAll('.option-text')).map(input => input.value);
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    
                    if (!correctAnswer) {
                        window.showMessageBox('يرجى اختيار الإجابة الصحيحة لجميع الأسئلة');
                        return;
                    }

                    questionData.options = options;
                    questionData.correctAnswer = parseInt(correctAnswer.value);
                } else if (q.type === 'boolean') {
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    
                    if (!correctAnswer) {
                        window.showMessageBox('يرجى اختيار الإجابة الصحيحة لجميع الأسئلة');
                        return;
                    }

                    questionData.correctAnswer = correctAnswer.value === 'true';
                } else if (q.type === 'text') {
                    const correctText = questionDiv.querySelector('.correct-text').value;
                    
                    if (!correctText.trim()) {
                        window.showMessageBox('يرجى إدخال الإجابة الصحيحة لجميع الأسئلة');
                        return;
                    }

                    questionData.correctAnswer = correctText.trim();
                }

                quiz.questions.push(questionData);
            }

            try {
                const quizDocRef = collection(db, `artifacts/${appId}/users/${currentUserId}/quizzes`);
                if (editQuizId) {
                    // Update existing quiz in Firestore
                    await setDoc(doc(quizDocRef, editQuizId), quiz);
                    window.showMessageBox('تم تعديل الكويز بنجاح!');
                } else {
                    // Add new quiz to Firestore
                    await addDoc(quizDocRef, quiz);
                    window.showMessageBox('تم حفظ الكويز بنجاح!');
                }
            } catch (e) {
                console.error("Error saving quiz: ", e);
                window.showMessageBox("حدث خطأ أثناء حفظ الكويز. يرجى المحاولة مرة أخرى.");
            }
            
            window.clearQuizForm();
            window.loadSavedQuizzes();
        }

        window.encodeImageFileAsURL = function(file) { // Made global
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    resolve(reader.result);
                };
                reader.readAsDataURL(file);
            });
        }

        window.clearQuizForm = function() { // Made global
            document.getElementById('quizTitle').value = '';
            document.getElementById('quizDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>';
            document.getElementById('editQuizId').value = ''; // Clear edit ID
            questions = [];
        }

        window.loadSavedQuizzes = async function() { // Made global
            if (!isAuthReady || !currentUserId) {
                console.log("Waiting for authentication to load quizzes...");
                return;
            }

            const container = document.getElementById('savedQuizzes');
            container.innerHTML = '<p class="text-gray-500 text-center col-span-full">جاري تحميل الكويزات...</p>';

            try {
                const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/quizzes`));
                const querySnapshot = await getDocs(q);
                const savedQuizzes = [];
                querySnapshot.forEach((doc) => {
                    savedQuizzes.push({ id: doc.id, ...doc.data() });
                });

                if (savedQuizzes.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center col-span-full">لا توجد كويزات محفوظة</p>';
                    return;
                }

                container.innerHTML = savedQuizzes.map(quiz => `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${quiz.title}</h3>
                        <p class="text-gray-600 mb-2">${quiz.description}</p>
                        <p class="text-sm text-gray-500 mb-3">
                            <i class="fas fa-calendar ml-1"></i>${quiz.createdAt} | 
                            <i class="fas fa-question-circle ml-1"></i>${quiz.questions.length} سؤال
                        </p>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="copyQuizLink('${quiz.id}', '${quiz.teacherId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition">
                                <i class="fas fa-link ml-1"></i>نسخ الرابط
                            </button>
                            <button onclick="viewQuizResultsForTeacher('${quiz.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition">
                                <i class="fas fa-chart-bar ml-1"></i>النتائج
                            </button>
                            <button onclick="editQuiz('${quiz.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition">
                                <i class="fas fa-edit ml-1"></i>تعديل
                            </button>
                            <button onclick="deleteQuiz('${quiz.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition">
                                <i class="fas fa-trash ml-1"></i>حذف
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Error loading quizzes: ", e);
                container.innerHTML = '<p class="text-red-500 text-center col-span-full">حدث خطأ أثناء تحميل الكويزات.</p>';
            }
        }

        window.editQuiz = async function(quizId) { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox('الرجاء الانتظار حتى يتم تهيئة المصادقة.');
                return;
            }
            try {
                const quizDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/quizzes`, quizId);
                const quizDocSnap = await getDoc(quizDocRef);

                if (!quizDocSnap.exists()) {
                    window.showMessageBox('الكويز المراد تعديله غير موجود.');
                    return;
                }

                const quizToEdit = { id: quizDocSnap.id, ...quizDocSnap.data() };

                document.getElementById('quizTitle').value = quizToEdit.title;
                document.getElementById('quizDescription').value = quizToEdit.description;
                document.getElementById('editQuizId').value = quizToEdit.id; // Set ID for editing

                // Clear current questions and load questions from the quiz to edit
                document.getElementById('questionsContainer').innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>';
                questions = []; // Reset questions array

                quizToEdit.questions.forEach(q => {
                    window.addQuestion(q.type, q); // Pass existing question data
                });

                // Scroll to the top of the form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                console.error("Error editing quiz:", e);
                window.showMessageBox("حدث خطأ أثناء تحميل الكويز للتعديل.");
            }
        }

        window.copyQuizLink = function(quizId, teacherId) { // Made global
            // Include teacherId in the URL for student to access public quiz
            const link = `${window.location.origin}${window.location.pathname}?quiz=${quizId}&teacher=${teacherId}`;
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            window.showMessageBox('تم نسخ الرابط! يمكنك مشاركته مع الطلاب');
        }

        window.deleteQuiz = function(quizId) { // Made global
            window.showConfirmBox('هل أنت متأكد من حذف هذا الكويز؟', async () => {
                if (!isAuthReady || !currentUserId) {
                    window.showMessageBox('الرجاء الانتظار حتى يتم تهيئة المصادقة.');
                    return;
                }
                try {
                    // Delete quiz document
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/quizzes`, quizId));
                    // Delete all results associated with this quiz
                    const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                    // IMPORTANT: Filter by quizId and teacherId to ensure proper deletion permissions
                    const q = query(resultsRef, where("quizId", "==", quizId), where("teacherId", "==", currentUserId));
                    const querySnapshot = await getDocs(q);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);

                    window.loadSavedQuizzes();
                    window.showMessageBox('تم حذف الكويز ونتائجه بنجاح');
                } catch (e) {
                    console.error("Error deleting quiz:", e);
                    window.showMessageBox("حدث خطأ أثناء حذف الكويز.");
                }
            });
        }

        // --- Student Functions ---
        window.loadQuizForStudent = async function(quizId, teacherIdFromUrl) { // Made global
            if (!isAuthReady) {
                console.log("Waiting for authentication to load student quiz...");
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.loadQuizForStudent(quizId, teacherIdFromUrl);
                        unsubscribe(); // Stop listening after auth is ready
                    }
                });
                return;
            }

            let quiz = null;
            let actualTeacherId = teacherIdFromUrl; // Use URL teacherId if provided

            // Try to load quiz from the teacher's collection
            try {
                const quizDocRef = doc(db, `artifacts/${appId}/users/${actualTeacherId}/quizzes`, quizId);
                const quizDocSnap = await getDoc(quizDocRef);
                if (quizDocSnap.exists()) {
                    quiz = { id: quizDocSnap.id, ...quizDocSnap.data() };
                } else {
                    // Fallback: if teacherId from URL is missing or incorrect, search for quiz by ID across all teachers
                    // This is less efficient but ensures quiz loads if link is incomplete
                    const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                    const usersSnapshot = await getDocs(usersCollectionRef);
                    for (const userDoc of usersSnapshot.docs) {
                        const quizzesCollectionRef = collection(db, `artifacts/${appId}/users/${userDoc.id}/quizzes`);
                        const qQuiz = query(quizzesCollectionRef, where("__name__", "==", quizId));
                        const quizSnapshot = await getDocs(qQuiz);
                        if (!quizSnapshot.empty) {
                            foundQuizDoc = quizSnapshot.docs[0];
                            quiz = { id: foundQuizDoc.id, ...foundQuizDoc.data() };
                            actualTeacherId = userDoc.id; // Update actualTeacherId
                            break;
                        }
                    }
                }
            } catch (e) {
                console.error("Error loading quiz for student:", e);
            }

            if (!quiz) {
                document.getElementById('quizContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">الكويز غير موجود</h2>
                        <p class="text-gray-600">الرابط الذي تحاول الوصول إليه غير صحيح أو تم حذف الكويز</p>
                    </div>
                `;
                document.getElementById('studentInfoForm').classList.add('hidden'); // Hide info form
                window.showStudentPage(); // Show student page (with error message)
                return;
            }

            currentQuiz = quiz;
            studentAnswers = {}; // Reset student answers for a new attempt or session

            // Show student user ID
            const studentUserIdElement = document.getElementById('studentUserId');
            if (studentUserIdElement) {
                studentUserIdElement.textContent = currentUserId;
            }

            const storedStudentName = sessionStorage.getItem('currentStudentName');

            // Try to load saved progress from localStorage for this specific quiz and student
            let savedProgress = null;
            try {
                const storedData = localStorage.getItem(QUIZ_PROGRESS_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData.quizId === quiz.id && parsedData.studentId === currentUserId) {
                        savedProgress = parsedData;
                    } else {
                        // Clear stale progress if it's for a different quiz/student
                        localStorage.removeItem(QUIZ_PROGRESS_STORAGE_KEY);
                    }
                }
            } catch (e) {
                console.error("Error loading quiz progress from localStorage:", e);
                localStorage.removeItem(QUIZ_PROGRESS_STORAGE_KEY); // Clear corrupted data
            }

            // Check if there are already submitted results for this student on this quiz
            // If so, automatically show them their results.
            try {
                const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                const qResults = query(resultsRef,
                    where("quizId", "==", quiz.id),
                    where("studentId", "==", currentUserId),
                    where("teacherId", "==", actualTeacherId || quiz.teacherId) // Use actualTeacherId if found, else quiz.teacherId
                );
                const querySnapshot = await getDocs(qResults);
                if (!querySnapshot.empty) {
                    // Sort results by submission time and show the latest
                    const latestResult = querySnapshot.docs
                        .map(doc => doc.data())
                        .sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt))
                        .pop();
                    
                    window.displayInlineResults(latestResult, quiz);
                    return; // Stop here, show results instead of quiz
                }
            } catch (e) {
                console.error("Error checking for previous quiz results:", e);
                // Continue to show quiz if check fails
            }


            if (storedStudentName) {
                studentAnswers.studentName = storedStudentName;
                document.getElementById('studentInfoForm').classList.add('hidden');
                document.getElementById('quizContent').classList.remove('hidden');
                document.getElementById('studentName').value = storedStudentName; // Pre-fill the input
            } else {
                document.getElementById('studentInfoForm').classList.remove('hidden');
                document.getElementById('quizContent').classList.add('hidden');
            }

            const quizHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${quiz.title}</h1>
                    <p class="text-gray-600 text-lg">${quiz.description}</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                        <i class="fas fa-info-circle text-blue-500 ml-2"></i>
                        عدد الأسئلة: ${quiz.questions.length}
                    </div>
                </div>

                <form id="studentQuizForm">
                    ${quiz.questions.map((question, index) => {
                        let questionHTML = `
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">
                                        ${index + 1}
                                    </span>
                                    ${question.text}
                                </h3>
                                ${question.imageUrl ? `<img src="${question.imageUrl}" class="mt-2 mb-4 rounded-lg max-w-full h-auto" alt="صورة السؤال">` : ''}
                        `;

                        // Retrieve saved answer for this question
                        const savedAnswer = savedProgress?.answers?.[question.id]; // Can be undefined or null

                        if (question.type === 'multiple') {
                            questionHTML += `
                                <div class="space-y-3">
                                    ${question.options.map((option, optionIndex) => `
                                        <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                            <input type="radio" name="question_${question.id}" value="${optionIndex}" class="ml-3 text-blue-500 focus:ring-blue-500" ${savedAnswer !== undefined && savedAnswer !== null && parseInt(savedAnswer) === optionIndex ? 'checked' : ''} onchange="saveQuizProgress()">
                                            <span class="flex-1">${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            `;
                        } else if (question.type === 'boolean') {
                            questionHTML += `
                                <div class="space-y-3">
                                    <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                        <input type="radio" name="question_${question.id}" value="true" class="ml-3 text-blue-500 focus:ring-blue-500" ${savedAnswer === 'true' ? 'checked' : ''} onchange="saveQuizProgress()">
                                        <span class="flex-1">صح</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                        <input type="radio" name="question_${question.id}" value="false" class="ml-3 text-blue-500 focus:ring-blue-500" ${savedAnswer === 'false' ? 'checked' : ''} onchange="saveQuizProgress()">
                                        <span class="flex-1">خطأ</span>
                                    </label>
                                </div>
                            `;
                        } else if (question.type === 'text') {
                            questionHTML += `
                                <input type="text" name="question_${question.id}" 
                                       class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg"
                                       placeholder="اكتب إجابتك هنا..." value="${savedAnswer || ''}" oninput="saveQuizProgress()">
                            `;
                        }

                        questionHTML += '</div>';
                        return questionHTML;
                    }).join('')}

                    <div class="text-center mt-8">
                        <button type="button" onclick="submitStudentQuiz()" 
                                class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg transition hover:shadow-lg">
                            <i class="fas fa-paper-plane ml-2"></i>
                            إرسال الإجابات
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('quizContent').innerHTML = quizHTML;
            window.showStudentPage();
            // Automatically set studentAnswers from loaded progress if it exists
            if (savedProgress) {
                studentAnswers = { ...studentAnswers, ...savedProgress.answers };
            }
        }

        window.saveQuizProgress = function() {
            if (!currentQuiz || !currentUserId) return;

            const form = document.getElementById('studentQuizForm');
            const formData = new FormData(form);
            const currentAnswers = {};

            currentQuiz.questions.forEach(question => {
                const answer = formData.get(`question_${question.id}`);
                // Only save if an answer exists (not null or empty string for radios/text)
                if (answer !== null && answer !== '') {
                    currentAnswers[question.id] = answer;
                }
            });

            const progressState = {
                quizId: currentQuiz.id,
                studentId: currentUserId,
                answers: currentAnswers,
                timestamp: Date.now()
            };
            localStorage.setItem(QUIZ_PROGRESS_STORAGE_KEY, JSON.stringify(progressState));
        };


        window.startQuiz = function() { // Made global
            const studentName = document.getElementById('studentName').value;
            if (!studentName.trim()) {
                window.showMessageBox('يرجى إدخال اسم الطالب');
                return;
            }
            
            studentAnswers.studentName = studentName;
            sessionStorage.setItem('currentStudentName', studentName); // Save student name to sessionStorage
            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('quizContent').classList.remove('hidden');

            // Initial save of progress (empty answers)
            window.saveQuizProgress();
        }
            
        window.submitStudentQuiz = async function() { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox('الرجاء الانتظار حتى يتم تهيئة المصادقة.');
                return;
            }

            const studentName = studentAnswers.studentName;
            if (!studentName) {
                window.showMessageBox('حدث خطأ في بيانات الطالب، يرجى إعادة تحميل الصفحة');
                return;
            }

            const form = document.getElementById('studentQuizForm');
            const formData = new FormData(form);
            
            // التحقق من أن جميع الأسئلة تم الإجابة عليها
            let allAnswered = true;
            currentQuiz.questions.forEach(question => {
                const answer = formData.get(`question_${question.id}`);
                if (!answer || answer.trim() === '') {
                    allAnswered = false;
                }
                studentAnswers[question.id] = answer; // Update studentAnswers with final selections
            });

            if (!allAnswered) {
                window.showMessageBox('يرجى الإجابة على جميع الأسئلة قبل الإرسال');
                return;
            }

            // حساب النتيجة
            let correctAnswers = 0;
           
            const results = {
                quizId: currentQuiz.id,
                quizTitle: currentQuiz.title,
                studentName: studentName,
                studentId: currentUserId, // Save student's Firebase UID
                teacherId: currentQuiz.teacherId, // Save the teacher's ID from the quiz
                totalQuestions: currentQuiz.questions.length,
                answers: [],
                submittedAt: new Date().toLocaleString('ar-EG')
            };

            currentQuiz.questions.forEach(question => {
                const studentAnswer = studentAnswers[question.id];
                let isCorrect = false;

                if (question.type === 'multiple') {
                    isCorrect = parseInt(studentAnswer) === question.correctAnswer;
                } else if (question.type === 'boolean') {
                    isCorrect = (studentAnswer === 'true') === question.correctAnswer;
                } else if (question.type === 'text') {
                    isCorrect = studentAnswer.trim().toLowerCase() === question.correctAnswer.toLowerCase();
                }

                if (isCorrect) correctAnswers++;

                results.answers.push({
                    questionId: question.id,
                    questionText: question.text,
                    studentAnswer: studentAnswer,
                    correctAnswer: question.correctAnswer,
                    isCorrect: isCorrect,
                    questionType: question.type,
                    options: question.options || null,
                    explanation: question.explanation || null, // Include explanation
                    imageUrl: question.imageUrl || null // Include question image URL for review
                });
            });

            results.correctAnswers = correctAnswers;
            results.score = Math.round((correctAnswers / currentQuiz.questions.length) * 100);

            try {
                // Save results to a public collection accessible by the teacher (via teacherId)
                await addDoc(collection(db, `artifacts/${appId}/public/data/quiz_results`), results);
                window.showMessageBox('تم إرسال إجاباتك بنجاح!');
                
                // Clear quiz progress from localStorage after successful submission
                localStorage.removeItem(QUIZ_PROGRESS_STORAGE_KEY);

                // Update URL to reflect results page state
                // This makes direct refresh on results page work correctly
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('results', 'true');
                currentUrl.searchParams.set('studentId', currentUserId);
                currentUrl.searchParams.set('teacher', currentQuiz.teacherId);
                window.history.pushState({}, '', currentUrl.toString());

                // **** عرض النتائج مباشرة ****
                window.displayInlineResults(results, currentQuiz);

            } catch (e) {
                console.error("Error submitting quiz results: ", e);
                window.showMessageBox("حدث خطأ أثناء إرسال النتائج. يرجى المحاولة مرة أخرى.");
            }
        }

        // **** دالة جديدة لعرض النتائج مباشرة في الصفحة ****
        window.displayInlineResults = function(results, quiz) {
            // Hide quiz and student info forms, show results page
            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('quizContent').classList.add('hidden');
            window.showResultsPage();


            let resultsHTML = `
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full ${results.score >= 60 ? 'bg-green-100' : 'bg-red-100'} mb-4">
                        <i class="fas fa-${results.score >= 60 ? 'check' : 'times'} text-3xl ${results.score >= 60 ? 'text-green-500' : 'text-red-500'}"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">نتيجة الكويز</h1>
                    <h2 class="text-xl text-gray-600 mb-4">${results.quizTitle}</h2>
                    <div class="bg-gray-100 p-3 rounded-lg inline-block mb-4">
                        <i class="fas fa-user ml-2"></i>
                        اسم الطالب: ${results.studentName}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600">${results.score}%</div>
                            <div class="text-sm text-gray-600">النسبة المئوية</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600">${results.correctAnswers}</div>
                            <div class="text-sm text-gray-600">إجابات صحيحة</div>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-gray-600">${results.totalQuestions}</div>
                            <div class="text-sm text-gray-600">إجمالي الأسئلة</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">مراجعة الإجابات</h3>
                    ${results.answers.map((answer, index) => {
                        // Find the original question from the quiz to get options/details
                        const originalQuestion = quiz.questions.find(q => q.id == answer.questionId);

                        if (!originalQuestion) {
                            return `<div class="text-red-500">خطأ: لم يتم العثور على السؤال #${answer.questionId} في الكويز الأصلي.</div>`;
                        }

                        // Determine the student's answer text and correct answer text for display
                        let studentAnswerDisplay = '';
                        let correctAnswerDisplay = '';

                        if (answer.questionType === 'multiple') {
                            studentAnswerDisplay = originalQuestion.options[parseInt(answer.studentAnswer)];
                            correctAnswerDisplay = originalQuestion.options[originalQuestion.correctAnswer];
                        } else if (answer.questionType === 'boolean') {
                            studentAnswerDisplay = answer.studentAnswer === 'true' ? 'صح' : 'خطأ';
                            correctAnswerDisplay = originalQuestion.correctAnswer ? 'صح' : 'خطأ';
                        } else if (answer.questionType === 'text') {
                            studentAnswerDisplay = answer.studentAnswer;
                            correctAnswerDisplay = originalQuestion.correctAnswer;
                        }

                        return `
                            <div class="bg-gray-50 p-6 rounded-lg border-r-4 ${answer.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4">
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="text-lg font-semibold text-gray-800">
                                        <span class="bg-gray-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">
                                            ${index + 1}
                                        </span>
                                        ${answer.questionText}
                                    </h4>
                                    <span class="text-2xl ${answer.isCorrect ? 'text-green-500' : 'text-red-500'}">
                                        <i class="fas fa-${answer.isCorrect ? 'check-circle' : 'times-circle'}"></i>
                                    </span>
                                </div>
                                ${originalQuestion.imageUrl ? `<img src="${originalQuestion.imageUrl}" class="mt-2 mb-4 rounded-lg max-w-full h-auto" alt="صورة السؤال">` : ''}
                                
                                ${answer.questionType === 'multiple' ? `
                                    <div class="space-y-2 mt-4">
                                        ${originalQuestion.options.map((option, optionIndex) => {
                                            let optionClass = 'p-3 rounded-lg border text-gray-800 flex items-center';
                                            let iconHtml = '';
                                            const isStudentChoice = (originalQuestion.type === 'multiple' && parseInt(answer.studentAnswer) === optionIndex);
                                            const isCorrectOption = (originalQuestion.type === 'multiple' && originalQuestion.correctAnswer === optionIndex);

                                            if (isStudentChoice) {
                                                if (answer.isCorrect) {
                                                    optionClass = 'bg-green-100 border-green-500 text-green-800 font-semibold';
                                                    iconHtml = '<i class="fas fa-check-circle ml-2 text-green-500"></i>';
                                                } else {
                                                    optionClass = 'bg-red-100 border-red-500 text-red-800 font-semibold';
                                                    iconHtml = '<i class="fas fa-times-circle ml-2 text-red-500"></i>';
                                                }
                                            } else if (isCorrectOption) { // If it's the correct option but not student's choice
                                                optionClass = 'bg-green-50 border-green-300 text-green-700 font-semibold';
                                                iconHtml = '<i class="fas fa-check-circle ml-2 text-green-500"></i>';
                                            } else {
                                                // Default styling for other options
                                                optionClass = 'bg-white border-gray-200 text-gray-700';
                                            }
                                            return `
                                                <div class="${optionClass} flex items-center">
                                                    ${iconHtml}
                                                    <span class="flex-1">${option}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : answer.questionType === 'boolean' ? `
                                    <div class="space-y-2 mt-4">
                                        ${[true, false].map(boolValue => {
                                            const optionText = boolValue ? 'صح' : 'خطأ';
                                            let optionClass = 'p-3 rounded-lg border text-gray-800 flex items-center';
                                            let iconHtml = '';
                                            const isStudentChoice = (answer.studentAnswer === String(boolValue));
                                            const isCorrectOption = (originalQuestion.correctAnswer === boolValue);

                                            if (isStudentChoice) {
                                                if (answer.isCorrect) {
                                                    optionClass = 'bg-green-100 border-green-500 text-green-800 font-semibold';
                                                    iconHtml = '<i class="fas fa-check-circle ml-2 text-green-500"></i>';
                                                } else {
                                                    optionClass = 'bg-red-100 border-red-500 text-red-800 font-semibold';
                                                    iconHtml = '<i class="fas fa-times-circle ml-2 text-red-500"></i>';
                                                }
                                            } else if (isCorrectOption) {
                                                optionClass = 'bg-green-50 border-green-300 text-green-700 font-semibold';
                                                iconHtml = '<i class="fas fa-check-circle ml-2 text-green-500"></i>';
                                            } else {
                                                optionClass = 'bg-white border-gray-200 text-gray-700';
                                            }
                                            return `
                                                <div class="${optionClass} flex items-center">
                                                    ${iconHtml}
                                                    <span class="flex-1">${optionText}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white p-3 rounded border">
                                            <div class="text-sm font-medium text-gray-600 mb-1">إجابتك:</div>
                                            <div class="text-lg ${answer.isCorrect ? 'text-green-700' : 'text-red-700'}">${studentAnswerDisplay}</div>
                                        </div>
                                        <div class="bg-white p-3 rounded border">
                                            <div class="text-sm font-medium text-gray-600 mb-1">الإجابة الصحيحة:</div>
                                            <div class="text-lg text-green-700">${correctAnswerDisplay}</div>
                                        </div>
                                    </div>
                                `}

                                ${originalQuestion.explanation ? `
                                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mt-4">
                                        <div class="text-sm font-medium text-blue-700 mb-1">هامش توضيحي:</div>
                                        <p class="text-blue-800">${originalQuestion.explanation}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="text-center">
                    <button onclick="window.close()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-times ml-2"></i>إغلاق النافذة
                    </button>
                    <!-- يمكنك إضافة زر للعودة إلى صفحة الطالب أو الصفحة الرئيسية هنا -->
                </div>
            `;

            document.getElementById('resultsContent').innerHTML = resultsHTML;
        };


        window.showResults = async function(quizId, studentIdParam, teacherIdParam) { // Made global
            if (!isAuthReady || !currentUserId) {
                console.log("Waiting for authentication to show results...");
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.showResults(quizId, studentIdParam, teacherIdParam);
                        unsubscribe();
                    }
                });
                return;
            }

            let latestResult = null;
            let quiz = null;

            try {
                // Fetch the specific quiz first to get teacherId and questions
                let foundQuizDoc = null;
                if (teacherIdParam) {
                    const specificQuizDocRef = doc(db, `artifacts/${appId}/users/${teacherIdParam}/quizzes`, quizId);
                    const specificQuizSnap = await getDoc(specificQuizDocRef);
                    if (specificQuizSnap.exists()) {
                        foundQuizDoc = specificQuizSnap;
                    }
                } else {
                     // Fallback: search all teacher quizzes for the quizId (less efficient, but handles direct navigation)
                    const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                    const usersSnapshot = await getDocs(usersCollectionRef);
                    for (const userDoc of usersSnapshot.docs) {
                        const quizzesCollectionRef = collection(db, `artifacts/${appId}/users/${userDoc.id}/quizzes`);
                        const qQuiz = query(quizzesCollectionRef, where("__name__", "==", quizId));
                        const quizSnapshot = await getDocs(qQuiz);
                        if (!quizSnapshot.empty) {
                            foundQuizDoc = quizSnapshot.docs[0];
                            teacherIdParam = userDoc.id; // Set teacherId if found
                            break;
                        }
                    }
                }

                if (foundQuizDoc) {
                    quiz = { id: foundQuizDoc.id, ...foundQuizDoc.data() };
                } else {
                     document.getElementById('resultsContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">الكويز غير موجود</h2>
                            <p class="text-gray-600">لم يتم العثور على الكويز المرتبط بهذه النتائج.</p>
                        </div>
                    `;
                    window.showResultsPage();
                    return;
                }

                // Fetch results for the specific quiz and student
                const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                const qResults = query(resultsRef, 
                    where("quizId", "==", quizId),
                    where("studentId", "==", studentIdParam), // Use studentIdParam from URL
                    where("teacherId", "==", teacherIdParam) // Use teacherIdParam from URL
                );
                const querySnapshot = await getDocs(qResults);
                const allResultsForStudent = [];
                querySnapshot.forEach((doc) => {
                    allResultsForStudent.push({ id: doc.id, ...doc.data() });
                });

                if (allResultsForStudent.length === 0) {
                    document.getElementById('resultsContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-chart-bar text-gray-400 text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">لا توجد نتائج</h2>
                            <p class="text-gray-600">لم يتم العثور على نتائج لهذا الكويز للطالب الحالي.</p>
                        </div>
                    `;
                    window.showResultsPage();
                    return;
                }

                latestResult = allResultsForStudent[allResultsForStudent.length - 1]; // Get the latest attempt

                // Call the new displayInlineResults function to render the results
                window.displayInlineResults(latestResult, quiz);

            } catch (e) {
                console.error("Error showing results:", e);
                document.getElementById('resultsContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">خطأ في تحميل النتائج</h2>
                        <p class="text-gray-600">حدث خطأ أثناء محاولة عرض النتائج. يرجى التأكد من صحة الرابط.</p>
                    </div>
                `;
                window.showResultsPage();
            }
        }

        // --- Teacher View Results ---
        window.viewQuizResultsForTeacher = async function(quizId) { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox('الرجاء الانتظار حتى يتم تهيئة المصادقة.');
                return;
            }

            let quizTitle = "الكويز"; // Default title
            try {
                const quizDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/quizzes`, quizId);
                const quizDocSnap = await getDoc(quizDocRef);
                if (quizDocSnap.exists()) {
                    quizTitle = quizDocSnap.data().title;
                }
            } catch (e) {
                console.error("Error fetching quiz title for results:", e);
            }

            const allResults = [];
            try {
                const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                const q = query(resultsRef, 
                    where("quizId", "==", quizId),
                    where("teacherId", "==", currentUserId) // Filter results by teacherId
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    allResults.push({ id: doc.id, ...doc.data() });
                });
            } catch (e) {
                console.error("Error loading all quiz results for teacher:", e);
                window.showMessageBox("حدث خطأ أثناء تحميل نتائج الطلاب.");
                return;
            }

            if (allResults.length === 0) {
                window.showMessageBox('لا توجد نتائج لهذا الكويز بعد.');
                return;
            }

            // إحصائيات عامة
            const totalAttempts = allResults.length;
            const avgScore = Math.round(allResults.reduce((sum, result) => sum + result.score, 0) / totalAttempts);
            const passCount = allResults.filter(result => result.score >= 60).length;

            const statsHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeStatsModal(event)">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold text-gray-800">
                                    <i class="fas fa-chart-line text-blue-500 ml-2"></i>
                                    إحصائيات الكويز: ${quizTitle}
                                </h2>
                                <button onclick="closeStatsModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600">${totalAttempts}</div>
                                    <div class="text-sm text-gray-600">محاولات إجمالية</div>
                                </div>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600">${avgScore}%</div>
                                    <div class="text-sm text-gray-600">متوسط الدرجات</div>
                                </div>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600">${passCount}</div>
                                    <div class="text-sm text-gray-600">نجحوا (60%+)</div>
                                </div>
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-orange-600">${totalAttempts - passCount}</div>
                                    <div class="text-sm text-gray-600">لم ينجحوا</div>
                                </div>
                            </div>

                            <h3 class="text-xl font-bold text-gray-800 mb-4">جميع المحاولات</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${allResults.map((result, index) => `
                                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold text-gray-800">${result.studentName || 'طالب'}</div>
                                                <div class="text-sm text-gray-600">معرف الطالب: ${result.studentId || 'غير متوفر'}</div>
                                                <div class="text-sm text-gray-600">محاولة #${index + 1} - ${result.submittedAt}</div>
                                            </div>
                                            <div class="text-left">
                                                <div class="text-2xl font-bold ${result.score >= 60 ? 'text-green-600' : 'text-red-600'}">${result.score}%</div>
                                                <div class="text-sm text-gray-600">${result.correctAnswers}/${result.totalQuestions}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', statsHTML);
        }

        window.closeStatsModal = function(event) { // Made global
            if (event && event.target.closest('.bg-white')) return;
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
        }

        // --- Utility/UI Functions ---
        window.showStudentPage = function() { // Made global
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
        }

        window.showResultsPage = function() { // Made global
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
        }

        // دالة لعرض مربع رسالة مخصص بدلاً من alert
        window.showMessageBox = function(message) { // Made global
            const modalHTML = `
                <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <button onclick="document.getElementById('customAlertModal').remove()" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition">حسناً</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // دالة لعرض مربع تأكيد مخصص بدلاً من confirm
        window.showConfirmBox = function(message, onConfirmCallback) { // Made global
            const modalHTML = `
                <div id="customConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition">نعم</button>
                            <button id="confirmNoBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">إلغاء</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('confirmYesBtn').onclick = () => {
                document.getElementById('customConfirmModal').remove();
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
            };
            document.getElementById('confirmNoBtn').onclick = () => {
                document.getElementById('customConfirmModal').remove();
            };
        }
    </script>
</body>
</html>
