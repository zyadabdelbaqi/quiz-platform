<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الكويزات التعليمية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Amiri', serif;
        }
        #studentInfoForm {
            max-width: 600px;
            margin: 0 auto;
        }
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .student-mode { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .teacher-mode { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="teacherPage" class="hidden">
        <div class="teacher-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-graduation-cap mr-3"></i>
                    منصة كويزات MET
                </h1>
                <p class="text-center text-lg opacity-90"></p>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-plus-circle text-blue-500 mr-2"></i>
                    إنشاء / تعديل كويز
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">عنوان الكويز</label>
                        <input type="text" id="quizTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="أدخل عنوان الكويز">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">وصف الكويز</label>
                        <input type="text" id="quizDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="وصف مختصر للكويز">
                    </div>
                </div>

                <div id="questionsContainer" class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>
                </div>

                <div class="flex gap-4 mb-6">
                    <button onclick="addQuestion('multiple')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-list mr-2"></i>إضافة سؤال اختيار متعدد
                    </button>
                    <button onclick="addQuestion('boolean')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-check-circle mr-2"></i>إضافة سؤال صح/خطأ
                    </button>
                    <button onclick="addQuestion('text')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-edit mr-2"></i>إضافة سؤال نصي
                    </button>
                </div>

                <button onclick="saveQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-save mr-2"></i>حفظ الكويز
                </button>
                <button onclick="clearQuizForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg ml-2">
                    <i class="fas fa-eraser mr-2"></i>مسح النموذج
                </button>
                 <input type="hidden" id="editQuizId">
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-list text-green-500 mr-2"></i>
                    الكويزات المحفوظة
                </h2>
                <div id="savedQuizzes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            </div>
        </div>
    </div>

    <div id="studentPage" class="hidden">
        <div class="student-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-user-graduate mr-3"></i>
                    صفحة الطالب
                </h1>
                <p class="text-center text-lg opacity-90">أجب على الأسئلة بعناية</p>
            </div>
        </div>

        <div class="quiz-container px-4 py-8">
            <div id="studentInfoForm" class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">بيانات الطالب</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">اسم الطالب</label>
                    <input type="text" id="studentName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="أدخل اسمك الكامل">
                </div>
                <button onclick="startQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-play mr-2"></i>بدء الاختبار
                </button>
            </div>
            <div id="quizContent" class="bg-white rounded-lg shadow-lg p-6 hidden">
            </div>
        </div>
    </div>
    
    <div id="resultsPage" class="hidden">
        <div class="student-mode text-white py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-chart-bar mr-3"></i>
                    نتائج الكويز
                </h1>
            </div>
        </div>

        <div class="quiz-container px-4 py-8">
            <div id="resultsContent" class="bg-white rounded-lg shadow-lg p-6">
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let currentQuiz = null;
        let studentAnswers = {};

        // التحقق من نوع الصفحة عند التحميل
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            const results = urlParams.get('results');
            
            if (results && quizId) {
                showResults(quizId);
            } else if (quizId) {
                loadQuizForStudent(quizId);
            } else {
                showTeacherPage();
            }
        };

        // وظائف لعرض الصفحات المختلفة
        function showTeacherPage() {
            document.getElementById('teacherPage').classList.remove('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            loadSavedQuizzes();
        }

        function showStudentPage() {
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
        }

        function showResultsPage() {
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
        }

        // إضافة سؤال جديد لنموذج الكويز
        function addQuestion(type, questionData = {}) {
            const questionId = questionData.id || Date.now();
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4';
            questionDiv.id = `question-${questionId}`;

            let questionHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-700">سؤال ${questions.length + 1}</h4>
                    <button onclick="removeQuestion('${questionId}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <input type="text" placeholder="نص السؤال" class="question-text w-full p-3 border border-gray-300 rounded-lg mb-3" value="${questionData.text || ''}" required>
                <input type="file" class="question-image-upload w-full p-3 border border-gray-300 rounded-lg mb-3" accept="image/*">
                ${questionData.imageUrl ? `<img src="${questionData.imageUrl}" class="mt-2 mb-3 rounded-lg max-w-full h-auto" alt="صورة السؤال">` : ''}
            `;

            if (type === 'multiple') {
                questionHTML += `
                    <div class="options-container">
                        ${[0, 1, 2, 3].map(i => `
                            <div class="mb-2">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct-${questionId}" value="${i}" class="correct-answer" ${questionData.correctAnswer === i ? 'checked' : ''}>
                                    <input type="text" placeholder="خيار ${i + 1}" class="option-text flex-1 p-2 border border-gray-300 rounded" value="${(questionData.options && questionData.options[i]) || ''}">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">اختر الإجابة الصحيحة</p>
                    <textarea placeholder="هامش توضيحي (اختياري)" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'boolean') {
                questionHTML += `
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="true" class="correct-answer ml-2" ${questionData.correctAnswer === true ? 'checked' : ''}>
                            صحيح
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="false" class="correct-answer ml-2" ${questionData.correctAnswer === false ? 'checked' : ''}>
                            خطأ
                        </label>
                    </div>
                    <textarea placeholder="هامش توضيحي (اختياري)" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'text') {
                questionHTML += `
                    <input type="text" placeholder="الإجابة الصحيحة" class="correct-text w-full p-3 border border-gray-300 rounded-lg" value="${questionData.correctAnswer || ''}">
                `;
            }

            questionDiv.innerHTML = questionHTML;
            document.getElementById('questionsContainer').appendChild(questionDiv);

            // If it's a new question, push it to the questions array
            if (!questionData.id) {
                questions.push({
                    id: questionId,
                    type: type
                });
            } else {
                // If it's an existing question being re-added (e.g., during edit)
                // Ensure it's in the `questions` array or update it if needed.
                const existingIndex = questions.findIndex(q => q.id === questionId);
                if (existingIndex === -1) {
                    questions.push({
                        id: questionId,
                        type: type
                    });
                } else {
                    questions[existingIndex] = { id: questionId, type: type };
                }
            }
        }

        // إزالة سؤال من نموذج الكويز
        function removeQuestion(questionId) {
            document.getElementById(`question-${questionId}`).remove();
            questions = questions.filter(q => q.id != questionId);
        }

        // حفظ الكويز الحالي
        async function saveQuiz() {
            const title = document.getElementById('quizTitle').value;
            const description = document.getElementById('quizDescription').value;
            const editQuizId = document.getElementById('editQuizId').value;

            if (!title.trim()) {
                // Using a custom message box instead of alert
                showMessageBox('يرجى إدخال عنوان الكويز');
                return;
            }

            if (questions.length === 0) {
                showMessageBox('يرجى إضافة سؤال واحد على الأقل');
                return;
            }

            const quiz = {
                id: editQuizId || Date.now().toString(), // Use existing ID or generate new
                title: title,
                description: description,
                questions: [],
                createdAt: new Date().toLocaleString('ar-EG')
            };

            for (const q of questions) {
                const questionDiv = document.getElementById(`question-${q.id}`);
                const questionText = questionDiv.querySelector('.question-text').value;
                const explanationText = questionDiv.querySelector('.explanation-text') ? questionDiv.querySelector('.explanation-text').value : '';
                const imageFile = questionDiv.querySelector('.question-image-upload').files[0];
                let imageUrl = '';

                if (!questionText.trim()) {
                    showMessageBox('يرجى ملء جميع الأسئلة');
                    return;
                }

                if (imageFile) {
                    imageUrl = await encodeImageFileAsURL(imageFile);
                } else {
                    // Retain existing image if no new one is uploaded during edit
                    const existingImg = questionDiv.querySelector('img');
                    if (existingImg) {
                        imageUrl = existingImg.src;
                    }
                }

                const questionData = {
                    id: q.id,
                    text: questionText,
                    type: q.type,
                    explanation: explanationText,
                    imageUrl: imageUrl
                };

                if (q.type === 'multiple') {
                    const options = Array.from(questionDiv.querySelectorAll('.option-text')).map(input => input.value);
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    
                    if (!correctAnswer) {
                        showMessageBox('يرجى اختيار الإجابة الصحيحة لجميع الأسئلة');
                        return;
                    }

                    questionData.options = options;
                    questionData.correctAnswer = parseInt(correctAnswer.value);
                } else if (q.type === 'boolean') {
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    
                    if (!correctAnswer) {
                        showMessageBox('يرجى اختيار الإجابة الصحيحة لجميع الأسئلة');
                        return;
                    }

                    questionData.correctAnswer = correctAnswer.value === 'true';
                } else if (q.type === 'text') {
                    const correctText = questionDiv.querySelector('.correct-text').value;
                    
                    if (!correctText.trim()) {
                        showMessageBox('يرجى إدخال الإجابة الصحيحة لجميع الأسئلة');
                        return;
                    }

                    questionData.correctAnswer = correctText.trim();
                }

                quiz.questions.push(questionData);
            }

            // حفظ الكويز في sessionStorage
            let savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');

            if (editQuizId) {
                // Update existing quiz
                savedQuizzes = savedQuizzes.map(q => q.id === editQuizId ? quiz : q);
            } else {
                // Add new quiz
                savedQuizzes.push(quiz);
            }
            
            sessionStorage.setItem('quizzes', JSON.stringify(savedQuizzes));

            showMessageBox('تم حفظ الكويز بنجاح!');
            
            // إعادة تعيين النموذج
            clearQuizForm();
            loadSavedQuizzes();
        }

        // ترميز ملف الصورة كعنوان URL للتخزين
        function encodeImageFileAsURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    resolve(reader.result);
                };
                reader.readAsDataURL(file);
            });
        }

        // مسح نموذج إنشاء الكويز
        function clearQuizForm() {
            document.getElementById('quizTitle').value = '';
            document.getElementById('quizDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>';
            document.getElementById('editQuizId').value = ''; // Clear edit ID
            questions = [];
        }

        // تحميل وعرض الكويزات المحفوظة
        function loadSavedQuizzes() {
            let savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');
            const container = document.getElementById('savedQuizzes');

            // منطق الترحيل: التحقق من localStorage كخيار احتياطي
            if (savedQuizzes.length === 0) {
                const localStorageQuizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                if (localStorageQuizzes.length > 0) {
                    // ترحيل الكويزات من localStorage إلى sessionStorage
                    savedQuizzes = localStorageQuizzes;
                    sessionStorage.setItem('quizzes', JSON.stringify(savedQuizzes));
                    localStorage.removeItem('quizzes'); // مسح localStorage بعد الترحيل
                    
                    // ترحيل نتائج الكويز أيضاً
                    localStorageQuizzes.forEach(quiz => {
                        const quizResults = localStorage.getItem('quiz_results_' + quiz.id);
                        if (quizResults) {
                            sessionStorage.setItem('quiz_results_' + quiz.id, quizResults);
                            localStorage.removeItem('quiz_results_' + quiz.id);
                        }
                    });
                    showMessageBox('تم نقل الكويزات والنتائج المحفوظة سابقاً إلى الجلسة الحالية.');
                }
            }

            if (savedQuizzes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center col-span-full">لا توجد كويزات محفوظة</p>';
                return;
            }

            container.innerHTML = savedQuizzes.map(quiz => `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${quiz.title}</h3>
                    <p class="text-gray-600 mb-2">${quiz.description}</p>
                    <p class="text-sm text-gray-500 mb-3">
                        <i class="fas fa-calendar ml-1"></i>${quiz.createdAt} | 
                        <i class="fas fa-question-circle ml-1"></i>${quiz.questions.length} سؤال
                    </p>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="copyQuizLink('${quiz.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-link ml-1"></i>نسخ الرابط
                        </button>
                        <button onclick="viewQuizResults('${quiz.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-chart-bar ml-1"></i>النتائج
                        </button>
                        <button onclick="editQuiz('${quiz.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-edit ml-1"></i>تعديل
                        </button>
                        <button onclick="deleteQuiz('${quiz.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-trash ml-1"></i>حذف
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // تعديل كويز موجود
        function editQuiz(quizId) {
            const savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');
            const quizToEdit = savedQuizzes.find(q => q.id === quizId);

            if (!quizToEdit) {
                showMessageBox('الكويز المراد تعديله غير موجود.');
                return;
            }

            document.getElementById('quizTitle').value = quizToEdit.title;
            document.getElementById('quizDescription').value = quizToEdit.description;
            document.getElementById('editQuizId').value = quizToEdit.id; // Set ID for editing

            // Clear current questions and load questions from the quiz to edit
            document.getElementById('questionsContainer').innerHTML = '<h3 class="text-lg font-semibold text-gray-700 mb-4">الأسئلة</h3>';
            questions = []; // Reset questions array

            quizToEdit.questions.forEach(q => {
                addQuestion(q.type, q); // Pass existing question data
            });

            // Scroll to the top of the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // نسخ رابط الكويز إلى الحافظة
        function copyQuizLink(quizId) {
            const link = window.location.origin + window.location.pathname + '?quiz=' + quizId;
            
            // Create a temporary textarea element
            const tempInput = document.createElement('textarea');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select(); // Select the text
            tempInput.setSelectionRange(0, 99999); // For mobile devices

            try {
                // Execute the copy command
                document.execCommand('copy');
                showMessageBox('تم نسخ الرابط! يمكنك مشاركته مع الطلاب');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageBox('فشل في نسخ الرابط. يرجى النسخ يدوياً: ' + link);
            } finally {
                // Remove the temporary element
                document.body.removeChild(tempInput);
            }
        }

        // حذف كويز
        function deleteQuiz(quizId) {
            // Using a custom confirmation dialog instead of confirm()
            showConfirmBox('هل أنت متأكد من حذف هذا الكويز؟', () => {
                let savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');
                savedQuizzes = savedQuizzes.filter(quiz => quiz.id !== quizId);
                sessionStorage.setItem('quizzes', JSON.stringify(savedQuizzes));
                
                // حذف نتائج الكويز أيضاً
                sessionStorage.removeItem('quiz_results_' + quizId);
                
                loadSavedQuizzes();
                showMessageBox('تم حذف الكويز بنجاح');
            });
        }

        // تحميل الكويز للطالب
        function loadQuizForStudent(quizId) {
            const savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');
            const quiz = savedQuizzes.find(q => q.id === quizId);

            if (!quiz) {
                document.getElementById('quizContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">الكويز غير موجود</h2>
                        <p class="text-gray-600">الرابط الذي تحاول الوصول إليه غير صحيح أو تم حذف الكويز</p>
                    </div>
                `;
                showStudentPage();
                return;
            }

            currentQuiz = quiz;
            studentAnswers = {};

            const quizHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${quiz.title}</h1>
                    <p class="text-gray-600 text-lg">${quiz.description}</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                        <i class="fas fa-info-circle text-blue-500 ml-2"></i>
                        عدد الأسئلة: ${quiz.questions.length}
                    </div>
                </div>

                <form id="studentQuizForm">
                    ${quiz.questions.map((question, index) => {
                        let questionHTML = `
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">
                                        ${index + 1}
                                    </span>
                                    ${question.text}
                                </h3>
                                ${question.imageUrl ? `<img src="${question.imageUrl}" class="mt-2 mb-4 rounded-lg max-w-full h-auto" alt="صورة السؤال">` : ''}
                        `;

                        if (question.type === 'multiple') {
                            questionHTML += `
                                <div class="space-y-3">
                                    ${question.options.map((option, optionIndex) => `
                                        <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                            <input type="radio" name="question_${question.id}" value="${optionIndex}" class="ml-3 text-blue-500 focus:ring-blue-500">
                                            <span class="flex-1">${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            `;
                        } else if (question.type === 'boolean') {
                            questionHTML += `
                                <div class="space-y-3">
                                    <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                        <input type="radio" name="question_${question.id}" value="true" class="ml-3 text-blue-500 focus:ring-blue-500">
                                        <span class="flex-1">صحيح</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 cursor-pointer transition">
                                        <input type="radio" name="question_${question.id}" value="false" class="ml-3 text-blue-500 focus:ring-blue-500">
                                        <span class="flex-1">خطأ</span>
                                    </label>
                                </div>
                            `;
                        } else if (question.type === 'text') {
                            questionHTML += `
                                <input type="text" name="question_${question.id}" 
                                       class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg"
                                       placeholder="اكتب إجابتك هنا...">
                            `;
                        }

                        questionHTML += '</div>';
                        return questionHTML;
                    }).join('')}

                    <div class="text-center mt-8">
                        <button type="button" onclick="submitStudentQuiz()" 
                                class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg transition hover:shadow-lg">
                            <i class="fas fa-paper-plane ml-2"></i>
                            إرسال الإجابات
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('quizContent').innerHTML = quizHTML;
            showStudentPage();
        }

        // بدء الكويز للطالب
        function startQuiz() {
            const studentName = document.getElementById('studentName').value;
            if (!studentName.trim()) {
                showMessageBox('يرجى إدخال اسم الطالب');
                return;
            }
            
            studentAnswers.studentName = studentName;
            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('quizContent').classList.remove('hidden');
        }

        // إرسال إجابات الطالب
        function submitStudentQuiz() {
            const studentName = studentAnswers.studentName;
            if (!studentName) {
                showMessageBox('حدث خطأ في بيانات الطالب، يرجى إعادة تحميل الصفحة');
                return;
            }

            const form = document.getElementById('studentQuizForm');
            const formData = new FormData(form);
            
            // التحقق من أن جميع الأسئلة تم الإجابة عليها
            let allAnswered = true;
            currentQuiz.questions.forEach(question => {
                const answer = formData.get(`question_${question.id}`);
                if (!answer || answer.trim() === '') {
                    allAnswered = false;
                }
                studentAnswers[question.id] = answer;
            });

            if (!allAnswered) {
                showMessageBox('يرجى الإجابة على جميع الأسئلة قبل الإرسال');
                return;
            }

            // حساب النتيجة
            let correctAnswers = 0;
           
            const results = {
                quizId: currentQuiz.id,
                quizTitle: currentQuiz.title,
                studentName: studentName, // إضافة اسم الطالب هنا
                totalQuestions: currentQuiz.questions.length,
                answers: [],
                submittedAt: new Date().toLocaleString('ar-EG')
            };

            currentQuiz.questions.forEach(question => {
                const studentAnswer = studentAnswers[question.id];
                let isCorrect = false;

                if (question.type === 'multiple') {
                    isCorrect = parseInt(studentAnswer) === question.correctAnswer;
                } else if (question.type === 'boolean') {
                    isCorrect = (studentAnswer === 'true') === question.correctAnswer;
                } else if (question.type === 'text') {
                    isCorrect = studentAnswer.trim().toLowerCase() === question.correctAnswer.toLowerCase();
                }

                if (isCorrect) correctAnswers++;

                results.answers.push({
                    questionId: question.id,
                    questionText: question.text,
                    studentAnswer: studentAnswer,
                    correctAnswer: question.correctAnswer,
                    isCorrect: isCorrect,
                    questionType: question.type,
                    options: question.options || null,
                    explanation: question.explanation || null // Include explanation
                });
            });

            results.correctAnswers = correctAnswers;
            results.score = Math.round((correctAnswers / currentQuiz.questions.length) * 100);

            // حفظ النتيجة في sessionStorage
            const existingResults = JSON.parse(sessionStorage.getItem('quiz_results_' + currentQuiz.id) || '[]');
            existingResults.push(results);
            sessionStorage.setItem('quiz_results_' + currentQuiz.id, JSON.stringify(existingResults));

            // توجيه إلى صفحة النتائج
            window.location.href = window.location.pathname + '?quiz=' + currentQuiz.id + '&results=true';
        }

        // عرض نتائج الكويز
        function showResults(quizId) {
            const savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');
            const quiz = savedQuizzes.find(q => q.id === quizId);
            const allResults = JSON.parse(sessionStorage.getItem('quiz_results_' + quizId) || '[]');
            
            if (!quiz || allResults.length === 0) {
                document.getElementById('resultsContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-bar text-gray-400 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">لا توجد نتائج</h2>
                        <p class="text-gray-600">لم يتم العثور على نتائج لهذا الكويز</p>
                    </div>
                `;
                showResultsPage();
                return;
            }

            // أحدث نتيجة للطالب
            const latestResult = allResults[allResults.length - 1];

            let resultsHTML = `
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full ${latestResult.score >= 60 ? 'bg-green-100' : 'bg-red-100'} mb-4">
                        <i class="fas fa-${latestResult.score >= 60 ? 'check' : 'times'} text-3xl ${latestResult.score >= 60 ? 'text-green-500' : 'text-red-500'}"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">نتيجة الكويز</h1>
                    <h2 class="text-xl text-gray-600 mb-4">${latestResult.quizTitle}</h2>
                    <div class="bg-gray-100 p-3 rounded-lg inline-block mb-4">
                        <i class="fas fa-user ml-2"></i>
                        اسم الطالب: ${latestResult.studentName}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600">${latestResult.score}%</div>
                            <div class="text-sm text-gray-600">النسبة المئوية</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600">${latestResult.correctAnswers}</div>
                            <div class="text-sm text-gray-600">إجابات صحيحة</div>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-gray-600">${latestResult.totalQuestions}</div>
                            <div class="text-sm text-gray-600">إجمالي الأسئلة</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">مراجعة الإجابات</h3>
                    ${latestResult.answers.map((answer, index) => {
                        let correctAnswerText = '';
                        const question = quiz.questions.find(q => q.id == answer.questionId);

                        if (answer.questionType === 'multiple') {
                            correctAnswerText = quiz.questions.find(q => q.id == answer.questionId).options[answer.correctAnswer];
                        } else if (answer.questionType === 'boolean') {
                            correctAnswerText = answer.correctAnswer ? 'صحيح' : 'خطأ';
                        } else {
                            correctAnswerText = answer.correctAnswer;
                        }

                        let studentAnswerText = '';
                        if (answer.questionType === 'multiple') {
                            studentAnswerText = quiz.questions.find(q => q.id == answer.questionId).options[parseInt(answer.studentAnswer)];
                        } else if (answer.questionType === 'boolean') {
                            studentAnswerText = answer.studentAnswer === 'true' ? 'صحيح' : 'خطأ';
                        } else {
                            studentAnswerText = answer.studentAnswer;
                        }

                        return `
                            <div class="bg-gray-50 p-6 rounded-lg border-r-4 ${answer.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4">
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="text-lg font-semibold text-gray-800">
                                        <span class="bg-gray-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">
                                            ${index + 1}
                                        </span>
                                        ${answer.questionText}
                                    </h4>
                                    <span class="text-2xl ${answer.isCorrect ? 'text-green-500' : 'text-red-500'}">
                                        <i class="fas fa-${answer.isCorrect ? 'check-circle' : 'times-circle'}"></i>
                                    </span>
                                </div>
                                ${question.imageUrl ? `<img src="${question.imageUrl}" class="mt-2 mb-4 rounded-lg max-w-full h-auto" alt="صورة السؤال">` : ''}
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-3 rounded border">
                                        <div class="text-sm font-medium text-gray-600 mb-1">إجابتك:</div>
                                        <div class="text-lg ${answer.isCorrect ? 'text-green-700' : 'text-red-700'}">${studentAnswerText}</div>
                                    </div>
                                    <div class="bg-white p-3 rounded border">
                                        <div class="text-sm font-medium text-gray-600 mb-1">الإجابة الصحيحة:</div>
                                        <div class="text-lg text-green-700">${correctAnswerText}</div>
                                    </div>
                                </div>
                                ${answer.explanation ? `
                                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mt-4">
                                        <div class="text-sm font-medium text-blue-700 mb-1">هامش توضيحي:</div>
                                        <p class="text-blue-800">${answer.explanation}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="text-center">
                    <button onclick="window.close()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-times ml-2"></i>إغلاق النافذة
                    </button>
                </div>
            `;

            document.getElementById('resultsContent').innerHTML = resultsHTML;
            showResultsPage();
        }

        // عرض نتائج الكويز العامة (عرض المعلم)
        function viewQuizResults(quizId) {
            const allResults = JSON.parse(sessionStorage.getItem('quiz_results_' + quizId) || '[]');
            const savedQuizzes = JSON.parse(sessionStorage.getItem('quizzes') || '[]');
            const quiz = savedQuizzes.find(q => q.id === quizId);

            if (allResults.length === 0) {
                showMessageBox('لا توجد نتائج لهذا الكويز بعد');
                return;
            }

            // الإحصائيات العامة
            const totalAttempts = allResults.length;
            const avgScore = Math.round(allResults.reduce((sum, result) => sum + result.score, 0) / totalAttempts);
            const passCount = allResults.filter(result => result.score >= 60).length;

            const statsHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeStatsModal(event)">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-2xl font-bold text-gray-800">
                                    <i class="fas fa-chart-line text-blue-500 ml-2"></i>
                                    إحصائيات الكويز: ${quiz.title}
                                </h2>
                                <button onclick="closeStatsModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600">${totalAttempts}</div>
                                    <div class="text-sm text-gray-600">محاولات إجمالية</div>
                                </div>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600">${avgScore}%</div>
                                    <div class="text-sm text-gray-600">متوسط الدرجات</div>
                                </div>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600">${passCount}</div>
                                    <div class="text-sm text-gray-600">نجحوا (60%+)</div>
                                </div>
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-orange-600">${totalAttempts - passCount}</div>
                                    <div class="text-sm text-gray-600">لم ينجحوا</div>
                                </div>
                            </div>

                            <h3 class="text-xl font-bold text-gray-800 mb-4">جميع المحاولات</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${allResults.map((result, index) => `
                                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold text-gray-800">${result.studentName || 'طالب'}</div>
                                                <div class="text-sm text-gray-600">محاولة #${index + 1} - ${result.submittedAt}</div>
                                            </div>
                                            <div class="text-left">
                                                <div class="text-2xl font-bold ${result.score >= 60 ? 'text-green-600' : 'text-red-600'}">${result.score}%</div>
                                                <div class="text-sm text-gray-600">${result.correctAnswers}/${result.totalQuestions}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', statsHTML);
        }

        // إغلاق نافذة الإحصائيات
        function closeStatsModal(event) {
            if (event && event.target.closest('.bg-white')) return;
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }

        // منع الوصول المباشر للصفحة الرئيسية من صفحة الطالب
        window.addEventListener('popstate', function(event) {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            const results = urlParams.get('results');
            
            if (results && quizId) {
                showResults(quizId);
            } else if (quizId) {
                loadQuizForStudent(quizId);
            } else {
                showTeacherPage();
            }
        });

        // منع تحديث F5/Ctrl+R في صفحة الطالب
        document.addEventListener('keydown', function(event) {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            
            if (quizId && (event.key === 'F5' || (event.ctrlKey && event.key === 'r'))) {
                event.preventDefault();
                location.reload();
            }
        });

        // دالة مخصصة لعرض رسالة بدلاً من alert()
        function showMessageBox(message) {
            const messageBoxHTML = `
                <div id="customMessageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-lg text-gray-800 mb-6">${message}</p>
                        <button onclick="document.getElementById('customMessageBox').remove()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                            موافق
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', messageBoxHTML);
        }

        // دالة مخصصة لعرض مربع تأكيد بدلاً من confirm()
        function showConfirmBox(message, onConfirm) {
            const confirmBoxHTML = `
                <div id="customConfirmBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-lg text-gray-800 mb-6">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button onclick="document.getElementById('customConfirmBox').remove(); window.tempOnConfirm();" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                                نعم
                            </button>
                            <button onclick="document.getElementById('customConfirmBox').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                                لا
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', confirmBoxHTML);
            // هذا حل بديل لاستدعاء الوظيفة بعد إزالة النافذة المنبثقة
            // في تطبيق حقيقي، ستمرر مرجعًا وتستدعيه مباشرة.
            window.tempOnConfirm = onConfirm; 
            document.querySelector('#customConfirmBox button.bg-green-500').setAttribute('onclick', "document.getElementById('customConfirmBox').remove(); window.tempOnConfirm(); delete window.tempOnConfirm;");
        }
    </script>
</body>
</html>
