<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كويزات MET</title>
    <!-- Improved Arabic and English Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Amiri:wght@400;500;700&family=Noto+Sans+Arabic:wght@440;500;700&family=Inter:wght@400;500;700&family=Cairo:wght@400;700&family=Changa:wght@440;700&family=IBM+Plex+Sans+Arabic:wght@400;700&family=Lateef&family=Reem+Kufi:wght@400;700&family=El+Messiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        /* General Styles */
        body {
            /* Default font for general content, will be overridden by html[lang] */
            font-family: 'Inter', sans-serif; /* Neutral default */
            background-color: #f3f4f6; /* Default background color */
            line-height: 1.6; /* Improved line spacing */
            text-align: left; /* Default text alignment (for English) */
        }

        /* Set base font for Arabic content to Tajawal */
        html[lang="ar"] body {
            font-family: 'Tajawal', 'Noto Sans Arabic', 'Amiri', 'Changa', 'IBM Plex Sans Arabic', 'Lateef', 'Reem Kufi', 'El Messiri', serif;
            text-align: right;
        }
        /* Set base font for English content to Inter */
        html[lang="en"] body {
            font-family: 'Inter', sans-serif;
            text-align: left;
        }

        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }

        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { transition: all 0.3s ease; }
        .question-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
        .student-mode { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .teacher-mode { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #studentInfoForm { max-width: 600px; margin: 0 auto; }

        /* General input and textarea alignment for RTL */
        input[type="text"], input[type="email"], input[type="password"], textarea {
            direction: rtl; /* Ensure input text direction is right-to-left */
            text-align: right; /* Align text within inputs to the right */
        }
        /* Specifically for login page inputs that are center-aligned */
        #loginPage input {
            text-align: center;
        }

        .language-selector {
            position: absolute;
            top: 1rem; /* 16px */
            padding: 0.5rem; /* 8px */
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            display: flex;
            gap: 0.5rem; /* gap-2 */
            z-index: 50; /* Ensure it's on top */
        }

        html[lang="ar"] .language-selector {
            right: 1rem;
            left: auto;
        }

        html[lang="en"] .language-selector {
            left: 1rem;
            right: auto;
        }

        .main-content-area {
            padding-top: 4rem; /* Adjust as needed, considering selector height + some margin */
        }

        @media (max-width: 640px) {
            .main-content-area {
                padding-top: 5rem;
            }
        }

        /* New styles for theme options - custom select */
        .custom-select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        /* Adjust background-position for the custom select arrow */
        .custom-select {
            display: block;
            width: 100%;
            padding: 0.75rem; /* p-3 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: white;
            appearance: none; /* Remove default browser styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1.5;
            color: #1f2937; /* text-gray-900 */
            background-image: url('data:image/svg+xml;utf8,<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>');
            background-repeat: no-repeat;
            /* Adjust position based on language direction */
            background-position: calc(100% - 0.75rem) center; /* For LTR (English) */
            background-size: 1.5em;
            padding-right: 2.5rem; /* Make space for the arrow for LTR */
        }

        html[lang="ar"] .custom-select {
            background-position: 0.75rem center; /* For RTL (Arabic) */
            padding-left: 2.5rem; /* Make space for the arrow for RTL */
            padding-right: 0.75rem; /* Reset right padding for RTL */
        }

        .custom-select:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* focus:ring-2 focus:ring-blue-500 */
        }

        .quiz-content-themed {
            transition: all 0.3s ease-in-out;
        }

        /* Custom styles for spacing between radio buttons/checkboxes and text */
        html[lang="ar"] input[type="radio"], html[lang="ar"] input[type="checkbox"] {
            margin-left: 0.5rem; /* Equivalent to ml-2 in Tailwind */
            margin-right: 0;
        }

        html[lang="en"] input[type="radio"], html[lang="en"] input[type="checkbox"] {
            margin-right: 0.5rem; /* Equivalent to mr-2 in Tailwind */
            margin-left: 0;
        }

        /* Spacing for Font Awesome icons when they are part of a text string or button */
        html[lang="ar"] .fa, html[lang="ar"] .fas, html[lang="ar"] .far, html[lang="ar"] .fab {
            margin-left: 0.5rem; /* Space to the left of the icon for Arabic */
            margin-right: 0;
        }
        html[lang="en"] .fa, html[lang="en"] .fas, html[lang="en"] .far, html[lang="en"] .fab {
            margin-right: 0.5rem; /* Space to the right of the icon for English */
            margin-left: 0;
        }

        .btn-primary .fa, .btn-primary .fas, .btn-primary .far, .btn-primary .fab,
        .bg-green-500 .fa, .bg-yellow-500 .fa, .bg-purple-500 .fa, .bg-gray-500 .fa {
            margin-right: 0.5rem !important; /* Forces a right margin for LTR icons */
            margin-left: 0 !important;
        }

        html[lang="ar"] .btn-primary .fa, html[lang="ar"] .btn-primary .fas, html[lang="ar"] .btn-primary .far, html[lang="ar"] .btn-primary .fab,
        html[lang="ar"] .bg-green-500 .fa, html[lang="ar"] .bg-yellow-500 .fa, html[lang="ar"] .bg-purple-500 .fa, html[lang="ar"] .bg-gray-500 .fa {
            margin-left: 0.5rem !important; /* Forces a left margin for RTL icons */
            margin-right: 0 !important;
        }
        
        /* --- RTL Overrides for Tailwind's Directional Margin utilities --- */
        /* This block ensures that classes like mr-2 (margin-right) are flipped to margin-left in RTL mode. */
        /* No overrides are needed for LTR (English) as that is the default behavior. */
        html[lang="ar"] .mr-1 { margin-left: 0.25rem !important; margin-right: unset !important; }
        html[lang="ar"] .mr-2 { margin-left: 0.5rem !important; margin-right: unset !important; }
        html[lang="ar"] .mr-3 { margin-left: 0.75rem !important; margin-right: unset !important; }
        html[lang="ar"] .mr-4 { margin-left: 1rem !important; margin-right: unset !important; }

        html[lang="ar"] .ml-1 { margin-right: 0.25rem !important; margin-left: unset !important; }
        html[lang="ar"] .ml-2 { margin-right: 0.5rem !important; margin-left: unset !important; }
        html[lang="ar"] .ml-3 { margin-right: 0.75rem !important; margin-left: unset !important; }
        html[lang="ar"] .ml-4 { margin-right: 1rem !important; margin-left: unset !important; }

        html[lang="ar"] .custom-radio-outer {
            margin-right: 0 !important; /* Remove default mr-3 if applied by Tailwind on RTL */
            margin-left: 0.75rem !important; /* Equivalent to ml-3 for Arabic */
        }

        html[lang="en"] .custom-radio-outer {
             margin-left: 0 !important; /* Remove default ml-3 if applied by Tailwind on LTR */
             margin-right: 0.75rem !important; /* Equivalent to mr-3 for English */
        }

        html[lang="ar"] .teacher-mode input[type="radio"].ml-2 {
            margin-left: 0 !important;
            margin-right: 0.5rem !important; /* Override with specific RTL margin */
        }

        html[lang="en"] .teacher-mode input[type="radio"].ml-2 {
            margin-right: 0 !important;
            margin-left: 0.5rem !important; /* Override with specific LTR margin */
        }

        /* Specific adjustments for buttons in saved quizzes section */
        .saved-quiz-button {
            /* This class will be applied to the buttons inside savedQuizzes container */
            display: inline-flex; /* Use flexbox to align icon and text */
            align-items: center; /* Vertically center items */
            padding: 0.25rem 0.75rem; /* py-1 px-3 for sm button */
            border-radius: 0.25rem; /* rounded */
            font-size: 0.875rem; /* text-sm */
            transition: all 0.15s ease-in-out;
        }

        /* Ensure consistent spacing between icon and text in buttons */
        .saved-quiz-button .fa, .saved-quiz-button .fas, .saved-quiz-button .far, .saved-quiz-button .fab {
            /* For LTR, icon should have margin-right */
            margin-right: 0.25rem; /* A small margin */
            margin-left: 0;
        }
        html[lang="ar"] .saved-quiz-button .fa, html[lang="ar"] .saved-quiz-button .fas, html[lang="ar"] .saved-quiz-button .far, html[lang="ar"] .saved-quiz-button .fab {
            /* For RTL, icon should have margin-left */
            margin-left: 0.25rem; /* A small margin */
            margin-right: 0;
        }
        
    </style>
</head>
<body class="bg-gray-100">
    <!-- Language Selector -->
    <div class="language-selector">
        <button onclick="setLanguage('ar')" class="px-3 py-1 rounded-md text-sm font-semibold hover:bg-gray-300 transition" data-lang-btn="ar">العربية</button>
        <button onclick="setLanguage('en')" class="px-3 py-1 rounded-md text-sm font-semibold hover:bg-gray-300 transition" data-lang-btn="en">English</button>
    </div>

    <!-- Login Page (New) -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 main-content-area">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center transform hover:scale-105 transition duration-300">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-lock text-purple-600 mr-2" data-translate-key="login_icon"></i>
                <span data-translate-key="login_title">تسجيل الدخول</span>
            </h1>
            <p class="text-gray-600 mb-6" data-translate-key="login_subtitle">يرجى إدخال البريد الإلكتروني وكلمة المرور</p>
            <input type="email" id="teacherEmail" 
                   class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4 text-lg" 
                   data-translate-key="email_placeholder" placeholder="البريد الإلكتروني" 
                   onkeypress="if(event.keyCode == 13) checkTeacherPassword()">
            <input type="password" id="teacherPassword" 
                   class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-4 text-lg" 
                   data-translate-key="password_placeholder" placeholder="كلمة المرور" 
                   onkeypress="if(event.keyCode == 13) checkTeacherPassword()">
            
            <!-- New Remember Me checkbox -->
            <div class="flex items-center justify-center mb-6">
                <input type="checkbox" id="rememberMe" class="form-checkbox h-4 w-4 text-purple-600 rounded">
                <label for="rememberMe" class="text-gray-700" data-translate-key="remember_me">تذكرني</label>
            </div>

            <button onclick="checkTeacherPassword()" 
                    class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg transition hover:shadow-xl hover:translate-y-1">
                <i class="fas fa-sign-in-alt mr-2" data-translate-key="enter_icon"></i>
                <span data-translate-key="enter_button">دخول</span>
            </button>
        </div>
    </div>

    <!-- Teacher Page -->
    <div id="teacherPage" class="hidden">
        <div class="teacher-mode text-white py-8 main-content-area">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-graduation-cap mr-3" data-translate-key="platform_icon"></i>
                    <span data-translate-key="platform_title">منصة كويزات MET</span>
                </h1>
                <p class="text-center text-lg opacity-90" data-translate-key="teacher_welcome"></p>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-plus-circle text-blue-500 mr-2" data-translate-key="create_edit_icon"></i>
                    <span data-translate-key="create_edit_quiz_title">إنشاء / تعديل كويز</span>
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" data-translate-key="quiz_title_label">عنوان الكويز</label>
                        <input type="text" id="quizTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-translate-key="quiz_title_placeholder" placeholder="أدخل عنوان الكويز">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" data-translate-key="quiz_description_label">وصف الكويز</label>
                        <input type="text" id="quizDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-translate-key="quiz_description_placeholder" placeholder="وصف مختصر للكويز">
                    </div>
                </div>

                <!-- New option: Allow students to see results -->
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="showResultsToStudents" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" checked>
                        <span class="ml-2 text-gray-700 font-semibold" data-translate-key="show_results_option">السماح للطلاب بمشاهدة النتائج فوراً</span>
                    </label>
                </div>

                <!-- Theme Options Section -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4" data-translate-key="theme_options_title">خيارات المظهر (للطلاب)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2" data-translate-key="background_color_label">لون الخلفية</label>
                            <input type="color" id="themeBackgroundColor" class="w-full h-10 border border-gray-300 rounded-lg" value="#f3f4f6">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2" data-translate-key="text_color_label">لون النص</label>
                            <input type="color" id="themeTextColor" class="w-full h-10 border border-gray-300 rounded-lg" value="#1f2937">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2" data-translate-key="font_family_label">نوع الخط</label>
                            <div class="custom-select-wrapper">
                                <select id="themeFontFamily" class="custom-select">
                                    <option value="Tajawal, Noto Sans Arabic, sans-serif" data-translate-key="font_tajawal">Tajawal (عربي)</option>
                                    <option value="Amiri, Noto Sans Arabic, serif" data-translate-key="font_amiri">Amiri (عربي)</option>
                                    <option value="Cairo, sans-serif" data-translate-key="font_cairo">Cairo (عربي)</option>
                                    <option value="Changa, sans-serif" data-translate-key="font_changa">Changa (عربي)</option>
                                    <option value="IBM Plex Sans Arabic, sans-serif" data-translate-key="font_ibm_plex_sans_arabic">IBM Plex Sans Arabic (عربي)</option>
                                    <option value="Lateef, serif" data-translate-key="font_lateef">Lateef (عربي)</option>
                                    <option value="Reem Kufi, sans-serif" data-translate-key="font_reem_kufi">Reem Kufi (عربي)</option>
                                    <option value="El Messiri, sans-serif" data-translate-key="font_el_messiri">El Messiri (عربي)</option>
                                    <option value="Inter, sans-serif" data-translate-key="font_inter">Inter (إنجليزي)</option>
                                    <option value="system-ui, sans-serif" data-translate-key="font_system_ui">System UI</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2" data-translate-key="font_size_label">حجم الخط</label>
                            <input type="number" id="themeFontSize" class="w-full p-3 border border-gray-300 rounded-lg" value="16" min="12" max="24">
                        </div>
                    </div>
                </div>

                <div id="questionsContainer" class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4" data-translate-key="questions_section_title">الأسئلة</h3>
                </div>

                <div class="flex gap-4 mb-6 flex-wrap">
                    <button onclick="addQuestion('multiple')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-list mr-2" data-translate-key="add_multiple_choice_icon"></i><span data-translate-key="add_multiple_choice">إضافة سؤال اختيار متعدد</span>
                    </button>
                    <button onclick="addQuestion('boolean')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-check-circle mr-2" data-translate-key="add_true_false_icon"></i><span data-translate-key="add_true_false">إضافة سؤال صح/خطأ</span>
                    </button>
                    <button onclick="addQuestion('text')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-edit mr-2" data-translate-key="add_text_icon"></i><span data-translate-key="add_text">إضافة سؤال نصي</span>
                    </button>
                </div>

                <button onclick="saveQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-save mr-2" data-translate-key="save_quiz_icon"></i><span data-translate-key="save_quiz_button">حفظ الكويز</span>
                </button>
                <button onclick="clearQuizForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg ml-2">
                    <i class="fas fa-eraser mr-2" data-translate-key="clear_form_icon"></i><span data-translate-key="clear_form_button">مسح النموذج</span>
                </button>
                 <input type="hidden" id="editQuizId">
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-list text-green-500 mr-2" data-translate-key="saved_quizzes_icon"></i>
                    <span data-translate-key="saved_quizzes_title">الكويزات المحفوظة</span>
                </h2>
                <div id="savedQuizzes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Saved quizzes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Student Page -->
    <div id="studentPage" class="hidden">
        <div class="student-mode text-white py-8 main-content-area">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-user-graduate mr-3" data-translate-key="student_page_icon"></i>
                    <span data-translate-key="student_page_title">صفحة الطالب</span>
                </h1>
                <p class="text-center text-lg opacity-90" data-translate-key="student_page_subtitle">أجب على الأسئلة بعناية</p>
                <p class="text-center text-sm mt-2">
                     <i class="fas fa-id-badge ml-1"></i> <span data-translate-key="user_id_label">معرف المستخدم:</span> <span id="studentUserId"></span>
                </p>
            </div>
        </div>

        <div class="quiz-container px-4 py-8">
            <div id="studentInfoForm" class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate-key="student_info_title">بيانات الطالب</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" data-translate-key="student_name_label">اسم الطالب</label>
                    <input type="text" id="studentName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" data-translate-key="student_name_placeholder" placeholder="أدخل اسمك الكامل">
                </div>
                <button onclick="startQuiz()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold transition hover:shadow-lg">
                    <i class="fas fa-play mr-2" data-translate-key="start_quiz_icon"></i><span data-translate-key="start_quiz_button">بدء الاختبار</span>
                </button>
            </div>
            <div id="quizContent" class="bg-white rounded-lg shadow-lg p-6 hidden quiz-content-themed">
                <!-- Quiz content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Results Page -->
    <div id="resultsPage" class="hidden">
        <div class="student-mode text-white py-8 main-content-area">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-center mb-2">
                    <i class="fas fa-chart-bar mr-3" data-translate-key="quiz_results_icon"></i>
                    <span data-translate-key="quiz_results_title">نتائج الكويز</span>
                </h1>
            </div>
        </div>

        <div class="quiz-container px-4 py-8">
            <div id="resultsContent" class="bg-white rounded-lg shadow-lg p-6 quiz-content-themed">
                <!-- Results will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Import signInWithEmailAndPassword for backend authentication
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration - Use __firebase_config if provided, else use the user's explicit config
        const firebaseConfig = JSON.parse(
            typeof __firebase_config !== 'undefined' && __firebase_config.length > 2 // Check if it's actually populated
                ? __firebase_config
                : '{"apiKey":"AIzaSyCTyHb79TSlbjwuebsb_Pd8VoqvWHEh-RI","authDomain":"my-quiz-app-77c96.firebaseapp.com","projectId":"my-quiz-app-77c96","storageBucket":"my-quiz-app-77c96.firebasestorage.app","messagingSenderId":"692482795107","appId":"1:692482795107:web:10ad0a80e523dfdaaa3a56"}'
        );

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables for Firebase instances and user ID
        let currentUserId = null;
        let isAuthReady = false; // Flag to ensure auth is ready before Firestore ops
        let unsubscribeTeacherResults = null; // To store the unsubscribe function for teacher results listener


        // Global variables for quiz management
        let questions = [];
        let currentQuiz = null;
        let studentAnswers = {}; // This will hold current answers in session

        // App ID for Firestore paths (from Canvas environment or default)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';

        // localStorage key for saving partial quiz progress
        const QUIZ_PROGRESS_STORAGE_KEY = 'quiz_student_progress';
        // localStorage keys for remembering teacher login
        const REMEMBER_EMAIL_KEY = 'teacher_email';
        const REMEMBER_PASSWORD_KEY = 'teacher_password';


        // --- Language and Translation Setup ---
        let currentLang = localStorage.getItem('quizAppLang') || 'ar'; // Default to Arabic

        const translations = {
            'ar': {
                'login_title': 'تسجيل الدخول',
                'login_icon': '', // Handled by font-awesome class
                'login_subtitle': 'يرجى إدخال البريد الإلكتروني وكلمة المرور', // Updated text
                'email_placeholder': 'البريد الإلكتروني', // New translation key
                'password_placeholder': 'كلمة المرور',
                'remember_me': 'تذكرني', // New translation
                'enter_button': 'دخول',
                'enter_icon': '', // Handled by font-awesome class
                'wrong_password': 'البريد الإلكتروني أو كلمة المرور غير صحيحة. يرجى المحاولة مرة أخرى.', // Updated error message
                'platform_title': 'منصة كويزات MET',
                'platform_icon': '', // Handled by font-awesome class
                'teacher_welcome': '', // Empty, as it's a dynamic message or just a placeholder
                'create_edit_quiz_title': 'إنشاء / تعديل كويز',
                'create_edit_icon': '', // Handled by font-awesome class
                'quiz_title_label': 'عنوان الكويز',
                'quiz_title_placeholder': 'أدخل عنوان الكويز',
                'quiz_description_label': 'وصف الكويز',
                'quiz_description_placeholder': 'وصف مختصر للكويز',
                'show_results_option': 'السماح للطلاب بمشاهدة النتائج فوراً', // New translation
                'theme_options_title': 'خيارات المظهر (للطلاب)', // New translation
                'background_color_label': 'لون الخلفية', // New translation
                'text_color_label': 'لون النص', // New translation
                'font_family_label': 'نوع الخط', // New translation
                'font_size_label': 'حجم الخط', // New translation
                'font_tajawal': 'Tajawal (عربي)', // New translation
                'font_amiri': 'Amiri (عربي)', // New translation
                'font_cairo': 'Cairo (عربي)', // New translation
                'font_changa': 'Changa (عربي)', // New translation
                'font_ibm_plex_sans_arabic': 'IBM Plex Sans Arabic (عربي)', // New translation
                'font_lateef': 'Lateef (عربي)', // New translation
                'font_reem_kufi': 'Reem Kufi (عربي)', // New translation
                'font_el_messiri': 'El Messiri (عربي)', // New translation
                'font_inter': 'Inter (إنجليزي)', // New translation
                'font_system_ui': 'System UI', // New translation
                'questions_section_title': 'الأسئلة',
                'add_multiple_choice': 'إضافة سؤال اختيار متعدد',
                'add_multiple_choice_icon': '', // Handled by font-awesome class
                'add_true_false': 'إضافة سؤال صح/خطأ',
                'add_true_false_icon': '', // Handled by font-awesome class
                'add_text': 'إضافة سؤال نصي',
                'add_text_icon': '', // Handled by font-awesome class
                'save_quiz_button': 'حفظ الكويز',
                'save_quiz_icon': '', // Handled by font-awesome class
                'clear_form_button': 'مسح النموذج',
                'clear_form_icon': '', // Handled by font-awesome class
                'saved_quizzes_title': 'الكويزات المحفوظة',
                'saved_quizzes_icon': '', // Handled by font-awesome class
                'please_wait_auth': 'الرجاء الانتظار حتى يتم تهيئة المصادقة.',
                'enter_quiz_title': 'يرجى إدخال عنوان الكويز',
                'add_at_least_one_question': 'يرجى إضافة سؤال واحد على الأقل',
                'fill_all_questions': 'يرجى ملء جميع الأسئلة',
                'choose_correct_answer': 'يرجى اختيار الإجابة الصحيحة لجميع الأسئلة',
                'enter_correct_answer': 'يرجى إدخال الإجابة الصحيحة لجميع الأسئلة',
                'quiz_saved_success': 'تم حفظ الكويز بنجاح!',
                'quiz_updated_success': 'تم تعديل الكويز بنجاح!',
                'error_saving_quiz': 'حدث خطأ أثناء حفظ الكويز. يرجى المحاولة مرة أخرى.',
                'loading_quizzes': 'جاري تحميل الكويزات...',
                'no_saved_quizzes': 'لا توجد كويزات محفوظة',
                'error_loading_quizzes': 'حدث خطأ أثناء تحميل الكويزات.',
                'question_text_placeholder': 'نص السؤال',
                'option_placeholder': 'خيار',
                'choose_correct_option': 'اختر الإجابة الصحيحة',
                'explanation_placeholder': 'هامش توضيحي (اختياري)',
                'true_text': 'صح',
                'false_text': 'خطأ',
                'correct_answer_placeholder': 'الإجابة الصحيحة',
                'quiz_link_copied': 'تم نسخ الرابط! يمكنك مشاركته مع الطلاب',
                'confirm_delete_quiz': 'هل أنت متأكد من حذف هذا الكويز؟',
                'quiz_deleted_success': 'تم حذف الكويز ونتائجه بنجاح',
                'error_deleting_quiz': 'حدث خطأ أثناء حذف الكويز.',
                'quiz_not_found': 'الكويز غير موجود',
                'quiz_not_found_desc': 'الرابط الذي تحاول الوصول إليه غير صحيح أو تم حذف الكويز',
                'student_page_title': 'صفحة الطالب',
                'student_page_icon': '', // Handled by font-awesome class
                'student_page_subtitle': 'أجب على الأسئلة بعناية',
                'user_id_label': 'معرف المستخدم:',
                'student_info_title': 'بيانات الطالب',
                'student_name_label': 'اسم الطالب',
                'student_name_placeholder': 'أدخل اسمك الكامل',
                'start_quiz_button': 'بدء الاختبار',
                'start_quiz_icon': '', // Handled by font-awesome class
                'enter_student_name': 'يرجى إدخال اسم الطالب',
                'error_student_data': 'حدث خطأ في بيانات الطالب، يرجى إعادة تحميل الصفحة',
                'answer_all_questions': 'يرجى الإجابة على جميع الأسئلة قبل الإرسال',
                'submit_answers_button': 'إرسال الإجابات',
                'submit_answers_icon': '', // Handled by font-awesome class
                'answers_submitted_success': 'تم إرسال إجاباتك بنجاح!',
                'results_not_shown_message': '', // New translation
                'error_submitting_answers': 'حدث خطأ أثناء إرسال النتائج. يرجى المحاولة مرة أخرى.',
                'quiz_results_title': 'نتائج الكويز',
                'quiz_results_icon': '', // Handled by font-awesome class
                'quiz_score_title': 'نتيجة الكويز',
                'student_name_display': 'اسم الطالب:',
                'percentage_score': 'النسبة المئوية',
                'correct_answers_count': 'إجابات صحيحة',
                'total_questions_count': 'إجمالي الأسئلة',
                'review_answers_title': 'مراجعة الإجابات',
                'error_question_not_found': 'خطأ: لم يتم العثور على السؤال في الكويز الأصلي.',
                'your_answer': 'إجابتك:',
                'correct_answer': 'الإجابة الصحيحة:',
                'explanation_note': 'هامش توضيحي:',
                'close_window_button': 'إغلاق النافذة',
                'no_results_found': 'لا توجد نتائج لهذا الكويز للطالب الحالي.',
                'error_loading_results': 'خطأ في تحميل النتائج',
                'error_loading_results_desc': 'حدث خطأ أثناء محاولة عرض النتائج. يرجى التأكد من صحة الرابط.',
                'quiz_stats_title': 'إحصائيات الكويز:',
                'total_attempts': 'محاولات إجمالية',
                'average_score': 'متوسط الدرجات',
                'passed_students': 'نجحوا (60%+)',
                'failed_students': 'لم ينجحوا',
                'all_attempts': 'جميع المحاولات',
                'student_id_display': 'معرف الطالب:',
                'attempt_number': 'محاولة #',
                'no_results_yet': 'لا توجد نتائج لهذا الكويز بعد.',
                'error_fetching_quiz_title': 'خطأ في جلب عنوان الكويز للنتائج:',
                'error_loading_teacher_results': 'حدث خطأ أثناء تحميل نتائج الطلاب.',
                'auth_error_signin': 'حدث خطأ في المصادقة: ',
                'auth_error_try_again': '. يرجى المحاولة مرة أخرى.',
                'awaiting_auth_load_quiz': 'جارٍ انتظار المصادقة لتحميل كويز الطالب...',
                'awaiting_auth_results': 'جارٍ انتظار المصادقة لعرض النتائج...',
                'awaiting_auth_teacher_results': 'الرجاء الانتظار حتى يتم تهيئة المصادقة.',
                'awaiting_auth_save_quiz': 'الرجاء الانتظار حتى يتم تهيئة المصادقة.',
                'image_question_alt': 'صورة السؤال',
                'question_number': 'سؤال',
                'back_to_teacher_page': 'العودة لصفحة المعلم',
                'email_required': 'الرجاء إدخال البريد الإلكتروني.',
                'password_required': 'الرجاء إدخال كلمة المرور.',
                'add_option_button': 'إضافة خيار', // New
                'remove_option_button': 'إزالة خيار' // New
            },
            'en': {
                'login_title': 'Login',
                'login_icon': '', // Handled by font-awesome class
                'login_subtitle': 'Please enter your email and password', // Updated text
                'email_placeholder': 'Email', // New translation key
                'password_placeholder': 'Password',
                'remember_me': 'Remember Me', // New translation
                'enter_button': 'Enter',
                'enter_icon': '', // Handled by font-awesome class
                'wrong_password': 'Incorrect email or password. Please try again.', // Updated error message
                'platform_title': 'MET Quizzes Platform',
                'platform_icon': '', // Handled by font-awesome class
                'teacher_welcome': '', // Empty, as it's a dynamic message or just a placeholder
                'create_edit_quiz_title': 'Create / Edit Quiz',
                'create_edit_icon': '', // Handled by font-awesome class
                'quiz_title_label': 'Quiz Title',
                'quiz_title_placeholder': 'Enter quiz title',
                'quiz_description_label': 'Quiz Description',
                'quiz_description_placeholder': 'Brief description of the quiz',
                'show_results_option': 'Allow students to see results immediately', // New translation
                'theme_options_title': 'Theme Options (for Students)', // New translation
                'background_color_label': 'Background Color', // New translation
                'text_color_label': 'Text Color', // New translation
                'font_family_label': 'Font Family', // New translation
                'font_size_label': 'Font Size', // New translation
                'font_tajawal': 'Tajawal (Arabic)', // New translation
                'font_amiri': 'Amiri (Arabic)', // New translation
                'font_cairo': 'Cairo (Arabic)', // New translation
                'font_changa': 'Changa (Arabic)', // New translation
                'font_ibm_plex_sans_arabic': 'IBM Plex Sans Arabic (Arabic)', // New translation
                'font_lateef': 'Lateef (Arabic)', // New translation
                'font_reem_kufi': 'Reem Kufi (Arabic)', // New translation
                'font_el_messiri': 'El Messiri (Arabic)', // New translation
                'font_inter': 'Inter (English)', // New translation
                'font_system_ui': 'System UI', // New translation
                'questions_section_title': 'Questions',
                'add_multiple_choice': 'Add Multiple Choice Question',
                'add_multiple_choice_icon': '', // Handled by font-awesome class
                'add_true_false': 'Add True/False Question',
                'add_true_false_icon': '', // Handled by font-awesome class
                'add_text': 'Add Text Question',
                'add_text_icon': '', // Handled by font-awesome class
                'save_quiz_button': 'Save Quiz',
                'save_quiz_icon': '', // Handled by font-awesome class
                'clear_form_button': 'Clear Form',
                'clear_form_icon': '', // Handled by font-awesome class
                'saved_quizzes_title': 'Saved Quizzes',
                'saved_quizzes_icon': '', // Handled by font-awesome class
                'please_wait_auth': 'Please wait until authentication is initialized.',
                'enter_quiz_title': 'Please enter the quiz title',
                'add_at_least_one_question': 'Please add at least one question',
                'fill_all_questions': 'Please fill in all questions',
                'choose_correct_answer': 'Please select the correct answer for all questions',
                'enter_correct_answer': 'Please enter the correct answer for all questions',
                'quiz_saved_success': 'Quiz saved successfully!',
                'quiz_updated_success': 'Quiz updated successfully!',
                'error_saving_quiz': 'An error occurred while saving the quiz. Please try again.',
                'loading_quizzes': 'Loading quizzes...',
                'no_saved_quizzes': 'No saved quizzes',
                'error_loading_quizzes': 'An error occurred while loading quizzes.',
                'question_text_placeholder': 'Question text',
                'option_placeholder': 'Option',
                'choose_correct_option': 'Choose the correct answer',
                'explanation_placeholder': 'Explanation (optional)',
                'true_text': 'True',
                'false_text': 'False',
                'correct_answer_placeholder': 'Correct Answer',
                'quiz_link_copied': 'Link copied! You can share it with students.',
                'confirm_delete_quiz': 'Are you sure you want to delete this quiz?',
                'quiz_deleted_success': 'Quiz and its results deleted successfully.',
                'error_deleting_quiz': 'An error occurred while deleting the quiz.',
                'quiz_not_found': 'Quiz Not Found',
                'quiz_not_found_desc': 'The link you are trying to access is incorrect or the quiz has been deleted.',
                'student_page_title': 'Student Page',
                'student_page_icon': '', // Handled by font-awesome class
                'student_page_subtitle': 'Answer the questions carefully',
                'user_id_label': 'User ID:',
                'student_info_title': 'Student Information',
                'student_name_label': 'Student Name',
                'student_name_placeholder': 'Enter your full name',
                'start_quiz_button': 'Start Quiz',
                'start_quiz_icon': '', // Handled by font-awesome class
                'enter_student_name': 'Please enter student name',
                'error_student_data': 'Error in student data, please reload the page',
                'answer_all_questions': 'Please answer all questions before submitting',
                'submit_answers_button': 'Submit Answers',
                'submit_answers_icon': '', // Handled by font-awesome class
                'answers_submitted_success': 'Your answers have been submitted successfully!',
                'results_not_shown_message': 'Your answers have been submitted successfully. Results will be displayed later by the teacher.', // New translation
                'error_submitting_answers': 'An error occurred while submitting results. Please try again.',
                'quiz_results_title': 'Quiz Results',
                'quiz_results_icon': '', // Handled by font-awesome class
                'quiz_score_title': 'Quiz Score',
                'student_name_display': 'Student Name:',
                'percentage_score': 'Percentage Score',
                'correct_answers_count': 'Correct Answers',
                'total_questions_count': 'Total Questions',
                'review_answers_title': 'Review Answers',
                'error_question_not_found': 'Error: Question not found in original quiz.',
                'your_answer': 'Your Answer:',
                'correct_answer': 'Correct Answer:',
                'explanation_note': 'Explanation Note:',
                'close_window_button': 'Close Window',
                'no_results_found': 'No results found for this quiz for the current student.',
                'error_loading_results': 'Error Loading Results',
                'error_loading_results_desc': 'An error occurred while attempting to display results. Please ensure the link is correct.',
                'quiz_stats_title': 'Quiz Statistics:',
                'total_attempts': 'Total Attempts',
                'average_score': 'Average Score',
                'passed_students': 'Passed (60%+)',
                'failed_students': 'Failed',
                'all_attempts': 'All Attempts',
                'student_id_display': 'Student ID:',
                'attempt_number': 'Attempt #',
                'no_results_yet': 'No results available for this quiz yet.',
                'error_fetching_quiz_title': 'Error fetching quiz title for results:',
                'error_loading_teacher_results': 'An error occurred while loading student results.',
                'auth_error_signin': 'Authentication error: ',
                'auth_error_try_again': '. Please try again.',
                'awaiting_auth_load_quiz': 'Awaiting authentication to load student quiz...',
                'awaiting_auth_results': 'Awaiting authentication to display results...',
                'awaiting_auth_teacher_results': 'Please wait until authentication is initialized.',
                'awaiting_auth_save_quiz': 'Please wait until authentication is initialized.',
                'image_question_alt': 'Question Image',
                'question_number': 'Question',
                'back_to_teacher_page': 'Back to Teacher Page',
                'email_required': 'Please enter an email.',
                'password_required': 'Please enter a password.',
                'add_option_button': 'Add Option', // New
                'remove_option_button': 'Remove Option' // New
            }
        };

        // Function to set the language and re-render content
        window.setLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('quizAppLang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = (lang === 'ar' ? 'rtl' : 'ltr');
            // Font application is now handled by CSS rules based on html[lang]
            // and by theme settings for quiz content.
            renderContent();
        };

        // Function to translate and render content
        function renderContent() {
            // Translate elements with data-translate-key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[currentLang] && translations[currentLang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.setAttribute('placeholder', translations[currentLang][key]);
                    } else if (element.tagName === 'OPTION' && element.hasAttribute('data-translate-key')) {
                        element.textContent = translations[currentLang][key]; // For option elements
                    }
                     else {
                        element.textContent = translations[currentLang][key];
                    }
                }
            });

            // Update button styles for active language
            document.querySelectorAll('[data-lang-btn]').forEach(button => {
                if (button.getAttribute('data-lang-btn') === currentLang) {
                    button.classList.add('bg-gray-300');
                    button.classList.remove('hover:bg-gray-300');
                } else {
                    button.classList.remove('bg-gray-300');
                    button.classList.add('hover:bg-gray-300');
                }
            });

            // Re-render dynamically generated content if pages are visible
            if (!document.getElementById('teacherPage').classList.contains('hidden')) {
                window.loadSavedQuizzes(); // Reload quizzes to re-render titles/descriptions
            }
            // Student page quiz content is rendered on loadQuizForStudent
            // Results page is rendered on displayInlineResults or showResults
        }
        
        // Initial language setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            window.setLanguage(currentLang);
        });

        // Firebase Authentication Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                // Sign in anonymously if no user is logged in
                try {
                    // Check if __initial_auth_token is provided, otherwise sign in anonymously
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    currentUserId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback for anonymous
                } catch (error) {
                    console.error(`${translations[currentLang].auth_error_signin}`, error);
                    showMessageBox(`${translations[currentLang].auth_error_signin}${error.message}${translations[currentLang].auth_error_try_again}`);
                }
            }
            isAuthReady = true;
            // Update UI with user ID if visible
            const studentUserIdElement = document.getElementById('studentUserId');
            if (studentUserIdElement) {
                studentUserIdElement.textContent = currentUserId;
            }
            // Once auth is ready, proceed with loading quiz data
            initializePage();
        });

        // Function to initialize the page based on URL parameters
        function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            const resultsParam = urlParams.get('results');
            const studentIdParam = urlParams.get('studentId'); // Passed when showing results on refresh
            const teacherIdParam = urlParams.get('teacher'); // Passed when showing results on refresh

            if (resultsParam && quizId && studentIdParam && teacherIdParam) {
                // If direct link to results page, show results
                window.showResults(quizId, studentIdParam, teacherIdParam);
            } else if (quizId) {
                // If direct link to quiz (student mode), load quiz for student
                window.loadQuizForStudent(quizId, teacherIdParam); // Pass teacherId to load quiz
            } else {
                // Default to login page if no specific quiz is requested
                window.showLoginPage();
            }
        }

        // --- New Login Page Functions ---
        window.showLoginPage = function() { // Made global
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.add('hidden');

            // Load remembered credentials if they exist
            const rememberedEmail = localStorage.getItem(REMEMBER_EMAIL_KEY);
            const rememberedPassword = localStorage.getItem(REMEMBER_PASSWORD_KEY);
            if (rememberedEmail && rememberedPassword) {
                document.getElementById('teacherEmail').value = rememberedEmail;
                document.getElementById('teacherPassword').value = rememberedPassword;
                document.getElementById('rememberMe').checked = true; // Check the box if remembered
            }
        }

        window.checkTeacherPassword = async function() { // Made global
            const enteredEmail = document.getElementById('teacherEmail').value;
            const enteredPassword = document.getElementById('teacherPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!enteredEmail.trim()) {
                window.showMessageBox(translations[currentLang].email_required);
                return;
            }
            if (!enteredPassword.trim()) {
                window.showMessageBox(translations[currentLang].password_required);
                return;
            }

            try {
                // Attempt to sign in with the entered email and password
                await signInWithEmailAndPassword(auth, enteredEmail, enteredPassword);
                
                // If login successful, handle "remember me"
                if (rememberMe) {
                    localStorage.setItem(REMEMBER_EMAIL_KEY, enteredEmail);
                    localStorage.setItem(REMEMBER_PASSWORD_KEY, enteredPassword);
                } else {
                    localStorage.removeItem(REMEMBER_EMAIL_KEY);
                    localStorage.removeItem(REMEMBER_PASSWORD_KEY);
                }

                document.getElementById('loginPage').classList.add('hidden');
                window.showTeacherPage();
            } catch (error) {
                let errorMessage = translations[currentLang].wrong_password;
                // Customize error messages based on Firebase error codes for better user experience
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = translations[currentLang].wrong_password;
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'صيغة البريد الإلكتروني غير صحيحة. يرجى التحقق.'; // Specific email format error
                } else {
                    errorMessage = `${translations[currentLang].auth_error_signin} ${error.message}`; // General Firebase error
                }
                
                // console.error("Firebase Authentication Error:", error); // For debugging
                window.showMessageBox(errorMessage);
                document.getElementById('teacherPassword').value = ''; // Clear password field
            }
        }

        // --- Teacher Functions ---
        window.showTeacherPage = function() { // Made global
            // This function is now called AFTER successful password check
            document.getElementById('teacherPage').classList.remove('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            document.getElementById('loginPage').classList.add('hidden'); // Hide login page
            if (isAuthReady) {
                window.loadSavedQuizzes();
            } else {
                // Wait for auth to be ready
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.loadSavedQuizzes();
                        unsubscribe(); // Stop listening after auth is ready
                    }
                });
            }
        }

        window.addQuestion = function(type, questionData = {}) { // Made global
            const questionId = questionData.id || Date.now().toString(); // Use string for ID
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4';
            questionDiv.id = `question-${questionId}`;

            let questionHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-700">${translations[currentLang].question_number} ${questions.length + 1}</h4>
                    <button onclick="removeQuestion('${questionId}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <input type="text" placeholder="${translations[currentLang].question_text_placeholder}" class="question-text w-full p-3 border border-gray-300 rounded-lg mb-3" value="${questionData.text || ''}" required>
                <input type="file" class="question-image-upload w-full p-3 border border-gray-300 rounded-lg mb-3" accept="image/*">
                ${questionData.imageUrl ? `<img src="${questionData.imageUrl}" class="mt-2 mb-3 rounded-lg max-w-full h-auto" alt="${translations[currentLang].image_question_alt}">` : ''}
            `;

            if (type === 'multiple') {
                questionHTML += `
                    <div class="options-container">
                        <!-- Options will be added here dynamically -->
                    </div>
                    <button type="button" onclick="addOptionToQuestion('${questionId}')" class="bg-blue-200 text-blue-800 text-sm font-semibold px-3 py-1 rounded-lg mt-3 hover:bg-blue-300 transition">
                        <i class="fas fa-plus mr-1"></i> <span data-translate-key="add_option_button"></span>
                    </button>
                    <p class="text-sm text-gray-600 mt-2">${translations[currentLang].choose_correct_option}</p>
                    <textarea placeholder="${translations[currentLang].explanation_placeholder}" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'boolean') {
                questionHTML += `
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="true" class="correct-answer ml-2" ${questionData.correctAnswer === true ? 'checked' : ''}>
                            ${translations[currentLang].true_text}
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="correct-${questionId}" value="false" class="correct-answer ml-2" ${questionData.correctAnswer === false ? 'checked' : ''}>
                            ${translations[currentLang].false_text}
                        </label>
                    </div>
                    <textarea placeholder="${translations[currentLang].explanation_placeholder}" class="explanation-text w-full p-3 border border-gray-300 rounded-lg mt-3">${questionData.explanation || ''}</textarea>
                `;
            } else if (type === 'text') {
                questionHTML += `
                    <input type="text" placeholder="${translations[currentLang].correct_answer_placeholder}" class="correct-text w-full p-3 border border-gray-300 rounded-lg" value="${questionData.correctAnswer || ''}">
                `;
            }

            questionDiv.innerHTML = questionHTML;
            document.getElementById('questionsContainer').appendChild(questionDiv);

            // If it's a new question, push it to the questions array and add default options if multiple choice
            if (!questionData.id) {
                questions.push({
                    id: questionId,
                    type: type
                });
                if (type === 'multiple') {
                    // Add two default options for new multiple choice questions
                    window.addOptionToQuestion(questionId, translations[currentLang].option_placeholder + ' 1');
                    window.addOptionToQuestion(questionId, translations[currentLang].option_placeholder + ' 2');
                }
            } else {
                // If it's an existing question being re-added (e.g., during edit)
                const existingIndex = questions.findIndex(q => q.id === questionId);
                if (existingIndex === -1) {
                    questions.push({
                        id: questionId,
                        type: type
                    });
                } else {
                    questions[existingIndex] = { id: questionId, type: type };
                }

                // If editing an existing multiple-choice question, populate its options
                if (type === 'multiple' && questionData.options && questionData.options.length > 0) {
                    questionData.options.forEach((optionText, index) => {
                        window.addOptionToQuestion(questionId, optionText, questionData.correctAnswer === index);
                    });
                } else if (type === 'multiple') {
                     // If existing MC question has no options (e.g., old format), add two default.
                    window.addOptionToQuestion(questionId, translations[currentLang].option_placeholder + ' 1');
                    window.addOptionToQuestion(questionId, translations[currentLang].option_placeholder + ' 2');
                }
            }

            // Apply translation to the new "Add Option" button
            const addOptionBtn = questionDiv.querySelector('[data-translate-key="add_option_button"]');
            if (addOptionBtn) {
                addOptionBtn.textContent = translations[currentLang].add_option_button;
            }
        }

        // New function to add an option to a specific multiple-choice question
        window.addOptionToQuestion = function(questionId, optionText = '', isCorrect = false) {
            const optionsContainer = document.querySelector(`#question-${questionId} .options-container`);
            if (!optionsContainer) return;

            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item flex items-center gap-2 mb-2';
            
            // Check if this option should be pre-selected as correct for editing
            const isChecked = isCorrect ? 'checked' : '';

            optionDiv.innerHTML = `
                <input type="radio" name="correct-${questionId}" value="${optionsContainer.children.length}" class="correct-answer ml-2" ${isChecked}>
                <input type="text" placeholder="${translations[currentLang].option_placeholder} ${optionsContainer.children.length + 1}" class="option-text flex-1 p-2 border border-gray-300 rounded" value="${optionText}">
                <button type="button" onclick="removeOption(this)" class="text-red-500 hover:text-red-700 p-1 rounded-full">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            optionsContainer.appendChild(optionDiv);

            // Reindex all options for this question after adding
            window.reindexOptions(questionId);
        }

        // New function to remove an option
        window.removeOption = function(buttonElement) {
            const optionItem = buttonElement.closest('.option-item');
            if (!optionItem) return;

            const questionDiv = buttonElement.closest('.question-card');
            const questionId = questionDiv.id.replace('question-', '');

            // Ensure there are at least two options remaining after deletion
            const optionsContainer = questionDiv.querySelector('.options-container');
            if (optionsContainer.children.length <= 2) {
                window.showMessageBox('يجب أن يحتوي سؤال الاختيار من متعدد على خيارين على الأقل.');
                return;
            }

            optionItem.remove();
            // Reindex all options for this question after removing
            window.reindexOptions(questionId);
        }

        // New function to reindex options after add/remove
        window.reindexOptions = function(questionId) {
            const optionsContainer = document.querySelector(`#question-${questionId} .options-container`);
            if (!optionsContainer) return;

            const optionItems = optionsContainer.querySelectorAll('.option-item');
            optionItems.forEach((item, index) => {
                const radio = item.querySelector('.correct-answer');
                const input = item.querySelector('.option-text');

                // Update radio button value
                radio.value = index;
                // Update input placeholder
                input.placeholder = `${translations[currentLang].option_placeholder} ${index + 1}`;
            });
        }


        window.removeQuestion = function(questionId) { // Made global
            document.getElementById(`question-${questionId}`).remove();
            questions = questions.filter(q => q.id != questionId);
        }

        window.saveQuiz = async function() { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox(translations[currentLang].please_wait_auth);
                return;
            }

            const title = document.getElementById('quizTitle').value;
            const description = document.getElementById('quizDescription').value;
            const showResultsToStudents = document.getElementById('showResultsToStudents').checked; // Get the checkbox value
            
            // Get theme options
            const themeBackgroundColor = document.getElementById('themeBackgroundColor').value;
            const themeTextColor = document.getElementById('themeTextColor').value;
            const themeFontFamily = document.getElementById('themeFontFamily').value;
            const themeFontSize = document.getElementById('themeFontSize').value;

            const editQuizId = document.getElementById('editQuizId').value;

            if (!title.trim()) {
                window.showMessageBox(translations[currentLang].enter_quiz_title);
                return;
            }

            if (questions.length === 0) {
                window.showMessageBox(translations[currentLang].add_at_least_one_question);
                return;
            }

            const quiz = {
                title: title,
                description: description,
                questions: [],
                createdAt: new Date().toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US'), // Localized date
                teacherId: currentUserId, // Link quiz to the teacher
                showResultsToStudents: showResultsToStudents, // Save the new setting
                theme: { // Save theme options
                    backgroundColor: themeBackgroundColor,
                    textColor: themeTextColor,
                    fontFamily: themeFontFamily,
                    fontSize: themeFontSize
                }
            };

            for (const q of questions) {
                const questionDiv = document.getElementById(`question-${q.id}`);
                const questionText = questionDiv.querySelector('.question-text').value;
                const explanationText = questionDiv.querySelector('.explanation-text') ? questionDiv.querySelector('.explanation-text').value : '';
                const imageFile = questionDiv.querySelector('.question-image-upload').files[0];
                let imageUrl = '';

                if (!imageFile) {
                    // If no new image is uploaded, check if there's an existing one from previous save/edit
                    const existingImgElement = questionDiv.querySelector(`img[alt="${translations[currentLang].image_question_alt}"]`);
                    if (existingImgElement) {
                        imageUrl = existingImgElement.src;
                    }
                } else {
                    imageUrl = await window.encodeImageFileAsURL(imageFile);
                }


                const questionData = {
                    id: q.id,
                    text: questionText,
                    type: q.type,
                    explanation: explanationText,
                    imageUrl: imageUrl
                };

                if (!questionText.trim()) {
                    window.showMessageBox(translations[currentLang].fill_all_questions);
                    return;
                }


                if (q.type === 'multiple') {
                    // Get all options dynamically
                    const options = Array.from(questionDiv.querySelectorAll('.option-text')).map(input => input.value);
                    const correctAnswerRadio = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    
                    if (!correctAnswerRadio) {
                        window.showMessageBox(translations[currentLang].choose_correct_answer);
                        return;
                    }
                    if (options.some(option => option.trim() === '') && options.length > 0) { // Check for empty options only if options exist
                         window.showMessageBox('الرجاء ملء جميع حقول الخيارات في أسئلة الاختيار من متعدد.'); // New validation message
                         return;
                    }


                    questionData.options = options;
                    questionData.correctAnswer = parseInt(correctAnswerRadio.value); // Value is the index
                } else if (q.type === 'boolean') {
                    const correctAnswer = questionDiv.querySelector('input[name="correct-' + q.id + '"]:checked');
                    
                    if (!correctAnswer) {
                        window.showMessageBox(translations[currentLang].choose_correct_answer);
                        return;
                    }

                    questionData.correctAnswer = correctAnswer.value === 'true';
                } else if (q.type === 'text') {
                    const correctText = questionDiv.querySelector('.correct-text').value;
                    
                    if (!correctText.trim()) {
                        window.showMessageBox(translations[currentLang].enter_correct_answer);
                        return;
                    }

                    questionData.correctAnswer = correctText.trim();
                }

                quiz.questions.push(questionData);
            }

            try {
                const quizDocRef = collection(db, `artifacts/${appId}/users/${currentUserId}/quizzes`);
                if (editQuizId) {
                    // Update existing quiz in Firestore
                    await setDoc(doc(quizDocRef, editQuizId), quiz);
                    window.showMessageBox(translations[currentLang].quiz_updated_success);
                } else {
                    // Add new quiz to Firestore
                    await addDoc(quizDocRef, quiz);
                    window.showMessageBox(translations[currentLang].quiz_saved_success);
                }
            } catch (e) {
                console.error("خطأ في حفظ الكويز: ", e);
                window.showMessageBox(translations[currentLang].error_saving_quiz);
            }
            
            window.clearQuizForm();
            window.loadSavedQuizzes();
        }

        window.encodeImageFileAsURL = function(file) { // Made global
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    resolve(reader.result);
                };
                reader.readAsDataURL(file);
            });
        }

        window.clearQuizForm = function() { // Made global
            document.getElementById('quizTitle').value = '';
            document.getElementById('quizDescription').value = '';
            document.getElementById('showResultsToStudents').checked = true; // Reset checkbox to default true
            // Reset theme options to defaults
            document.getElementById('themeBackgroundColor').value = '#f3f4f6';
            document.getElementById('themeTextColor').value = '#1f2937';
            document.getElementById('themeFontFamily').value = 'Tajawal, Noto Sans Arabic, sans-serif';
            document.getElementById('themeFontSize').value = '16';

            document.getElementById('questionsContainer').innerHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-4">${translations[currentLang].questions_section_title}</h3>`;
            document.getElementById('editQuizId').value = ''; // Clear edit ID
            questions = [];
        }

        // Utility function to escape single quotes for HTML attributes
        window.escapeHtmlAttribute = function(s) {
            return s.replace(/'/g, '&#39;');
        };

        window.loadSavedQuizzes = async function() { // Made global
            if (!isAuthReady || !currentUserId) {
                console.log(translations[currentLang].awaiting_auth_load_quiz);
                return;
            }

            const container = document.getElementById('savedQuizzes');
            container.innerHTML = `<p class="text-gray-500 text-center col-span-full">${translations[currentLang].loading_quizzes}</p>`;

            try {
                const q = query(collection(db, `artifacts/${appId}/users/${currentUserId}/quizzes`));
                const querySnapshot = await getDocs(q);
                const savedQuizzes = [];
                querySnapshot.forEach((doc) => {
                    savedQuizzes.push({ id: doc.id, ...doc.data() });
                });

                if (savedQuizzes.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center col-span-full">${translations[currentLang].no_saved_quizzes}</p>`;
                    return;
                }

                container.innerHTML = savedQuizzes.map(quiz => `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${quiz.title}</h3>
                        <p class="text-gray-600 mb-2">${quiz.description}</p>
                        <p class="text-sm text-gray-500 mb-3">
                            <i class="fas fa-calendar ml-1"></i>${quiz.createdAt} | 
                            <i class="fas fa-question-circle ml-1"></i>${quiz.questions.length} ${translations[currentLang].question_number}
                        </p>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="copyQuizLink('${escapeHtmlAttribute(encodeURIComponent(quiz.id))}', '${escapeHtmlAttribute(encodeURIComponent(quiz.teacherId))}')" class="bg-green-500 hover:bg-green-600 text-white saved-quiz-button">
                                <i class="fas fa-link"></i><span data-translate-key="copy_link_button_dynamic"></span>
                            </button>
                            <button onclick="viewQuizResultsForTeacher('${escapeHtmlAttribute(encodeURIComponent(quiz.id))}')" class="bg-blue-500 hover:bg-blue-600 text-white saved-quiz-button">
                                <i class="fas fa-chart-bar"></i><span data-translate-key="results_button_dynamic"></span>
                            </button>
                            <button onclick="editQuiz('${escapeHtmlAttribute(encodeURIComponent(quiz.id))}')" class="bg-yellow-500 hover:bg-yellow-600 text-white saved-quiz-button">
                                <i class="fas fa-edit"></i><span data-translate-key="edit_button_dynamic"></span>
                            </button>
                            <button onclick="deleteQuiz('${escapeHtmlAttribute(encodeURIComponent(quiz.id))}')" class="bg-red-500 hover:bg-red-600 text-white saved-quiz-button">
                                <i class="fas fa-trash"></i><span data-translate-key="delete_button_dynamic"></span>
                            </button>
                        </div>
                    </div>
                `).join('');

                // After rendering, apply translations to dynamically created buttons/spans
                container.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[currentLang][key]) {
                        el.textContent = translations[currentLang][key];
                    }
                });

                 // Manually set text for dynamic buttons as data-translate-key won't work in HTML template directly
                container.querySelectorAll('button span').forEach(span => {
                    if (span.parentNode.onclick.toString().includes('copyQuizLink')) {
                        span.textContent = translations[currentLang].copy_link_button_dynamic || 'Copy Link';
                    } else if (span.parentNode.onclick.toString().includes('viewQuizResultsForTeacher')) {
                        span.textContent = translations[currentLang].results_button_dynamic || 'Results';
                    } else if (span.parentNode.onclick.toString().includes('editQuiz')) {
                        span.textContent = translations[currentLang].edit_button_dynamic || 'Edit';
                    } else if (span.parentNode.onclick.toString().includes('deleteQuiz')) {
                        span.textContent = translations[currentLang].delete_quiz_dynamic || 'Delete'; /* Changed key name here */
                    }
                });


            } catch (e) {
                console.error("خطأ في تحميل الكويزات: ", e);
                container.innerHTML = `<p class="text-red-500 text-center col-span-full">${translations[currentLang].error_loading_quizzes}</p>`;
            }
        }

        window.editQuiz = async function(quizId) { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox(translations[currentLang].please_wait_auth);
                return;
            }
            try {
                // Decode quizId received from URL before using it in Firestore
                const decodedQuizId = decodeURIComponent(quizId);
                const quizDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/quizzes`, decodedQuizId);
                const quizDocSnap = await getDoc(quizDocRef);

                if (!quizDocSnap.exists()) {
                    window.showMessageBox(translations[currentLang].quiz_not_found);
                    return;
                }

                const quizToEdit = { id: quizDocSnap.id, ...quizDocSnap.data() };

                document.getElementById('quizTitle').value = quizToEdit.title;
                document.getElementById('quizDescription').value = quizToEdit.description;
                // Set the checkbox state based on the saved quiz data, default to true if not found
                document.getElementById('showResultsToStudents').checked = quizToEdit.showResultsToStudents !== undefined ? quizToEdit.showResultsToStudents : true;
                
                // Set theme options from quiz data, or use defaults if not present
                document.getElementById('themeBackgroundColor').value = quizToEdit.theme?.backgroundColor || '#f3f4f6';
                document.getElementById('themeTextColor').value = quizToEdit.theme?.textColor || '#1f2937';
                document.getElementById('themeFontFamily').value = quizToEdit.theme?.fontFamily || 'Tajawal, Noto Sans Arabic, sans-serif';
                document.getElementById('themeFontSize').value = quizToEdit.theme?.fontSize || '16';

                document.getElementById('editQuizId').value = quizToEdit.id; // Set ID for editing

                // Clear current questions and load questions from the quiz to edit
                document.getElementById('questionsContainer').innerHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-4">${translations[currentLang].questions_section_title}</h3>`;
                questions = []; // Reset questions array

                quizToEdit.questions.forEach(q => {
                    window.addQuestion(q.type, q); // Pass existing question data
                });

                // Scroll to the top of the form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                console.error("خطأ في تعديل الكويز:", e);
                window.showMessageBox(translations[currentLang].error_saving_quiz);
            }
        }

        window.copyQuizLink = function(quizId, teacherId) { // Made global
            // Include teacherId in the URL for student to access public quiz
            const link = `${window.location.origin}${window.location.pathname}?quiz=${encodeURIComponent(quizId)}&teacher=${encodeURIComponent(teacherId)}`;
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            window.showMessageBox(translations[currentLang].quiz_link_copied);
        }

        window.deleteQuiz = function(quizId) { // Made global
            window.showConfirmBox(translations[currentLang].confirm_delete_quiz, async () => {
                if (!isAuthReady || !currentUserId) {
                    window.showMessageBox(translations[currentLang].please_wait_auth);
                    return;
                }
                try {
                    // Decode quizId received from URL before using it in Firestore
                    const decodedQuizId = decodeURIComponent(quizId);
                    // Delete quiz document
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/quizzes`, decodedQuizId));
                    // Delete all results associated with this quiz
                    const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                    // IMPORTANT: Filter by quizId and teacherId to ensure proper deletion permissions
                    const q = query(resultsRef, where("quizId", "==", decodedQuizId), where("teacherId", "==", currentUserId));
                    const querySnapshot = await getDocs(q);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);

                    window.loadSavedQuizzes();
                    window.showMessageBox(translations[currentLang].quiz_deleted_success);
                } catch (e) {
                    console.error("خطأ في حذف الكويز:", e);
                    window.showMessageBox(translations[currentLang].error_deleting_quiz);
                }
            });
        }

        // --- Student Functions ---

        // Helper function to update the visual state of custom radio buttons
        window.handleOptionSelection = function(radioInput) {
            const parentLabel = radioInput.closest('label');
            const optionsContainer = parentLabel.closest('.space-y-3'); // Works for both multiple and boolean

            // Remove selected styles from all other labels in the same question
            optionsContainer.querySelectorAll('label').forEach(label => {
                label.classList.remove('bg-blue-50', 'border-blue-500', 'shadow-md');
                const customRadioOuter = label.querySelector('.custom-radio-outer');
                const customRadioInner = label.querySelector('.custom-radio-inner');
                if (customRadioOuter) customRadioOuter.classList.remove('bg-blue-500', 'border-blue-500');
                if (customRadioInner) {
                    customRadioInner.classList.add('hidden');
                    customRadioInner.classList.remove('block');
                }
            });

            // Add selected styles to the current label
            parentLabel.classList.add('bg-blue-50', 'border-blue-500', 'shadow-md');
            const currentCustomRadioOuter = parentLabel.querySelector('.custom-radio-outer');
            const currentCustomRadioInner = parentLabel.querySelector('.custom-radio-inner');
            if (currentCustomRadioOuter) currentCustomRadioOuter.classList.add('bg-blue-500', 'border-blue-500');
            if (currentCustomRadioInner) {
                currentCustomRadioInner.classList.add('block');
                currentCustomRadioInner.classList.remove('hidden');
            }

            // Then save progress
            saveQuizProgress();
        };

        window.loadQuizForStudent = async function(quizId, teacherIdFromUrl) { // Made global
            if (!isAuthReady) {
                console.log(translations[currentLang].awaiting_auth_load_quiz);
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.loadQuizForStudent(quizId, teacherIdFromUrl);
                        unsubscribe(); // Stop listening after auth is ready
                    }
                });
                return;
            }

            let quiz = null;
            // Decode quizId and teacherIdFromUrl received from the URL before using them
            const decodedQuizId = decodeURIComponent(quizId);
            let actualTeacherId = decodeURIComponent(teacherIdFromUrl); 

            // Try to load quiz from the teacher's collection
            try {
                const quizDocRef = doc(db, `artifacts/${appId}/users/${actualTeacherId}/quizzes`, decodedQuizId);
                const quizDocSnap = await getDoc(quizDocRef);
                if (quizDocSnap.exists()) {
                    quiz = { id: quizDocSnap.id, ...quizDocSnap.data() };
                } else {
                    // Fallback: if teacherId from URL is missing or incorrect, search for quiz by ID across all teachers
                    // This is less efficient but ensures quiz loads if link is incomplete
                    const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                    const usersSnapshot = await getDocs(usersCollectionRef);
                    for (const userDoc of usersSnapshot.docs) {
                        const quizzesCollectionRef = collection(db, `artifacts/${appId}/users/${userDoc.id}/quizzes`);
                        const qQuiz = query(quizzesCollectionRef, where("__name__", "==", decodedQuizId));
                        const quizSnapshot = await getDocs(qQuiz);
                        if (!quizSnapshot.empty) {
                            foundQuizDoc = quizSnapshot.docs[0];
                            quiz = { id: foundQuizDoc.id, ...foundQuizDoc.data() };
                            actualTeacherId = userDoc.id; // Update actualTeacherId
                            break;
                        }
                    }
                }
            } catch (e) {
                console.error("خطأ في تحميل الكويز للطالب:", e);
            }

            if (!quiz) {
                document.getElementById('quizContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${translations[currentLang].quiz_not_found}</h2>
                        <p class="text-gray-600">${translations[currentLang].quiz_not_found_desc}</p>
                    </div>
                `;
                document.getElementById('studentInfoForm').classList.add('hidden'); // Hide info form
                window.showStudentPage(); // Show student page (with error message)
                return;
            }

            currentQuiz = quiz;
            studentAnswers = {}; // Reset student answers for a new attempt or session

            // Apply theme settings to the quiz content and results page
            const quizContentElement = document.getElementById('quizContent');
            const resultsContentElement = document.getElementById('resultsContent');

            if (currentQuiz.theme) {
                quizContentElement.style.backgroundColor = currentQuiz.theme.backgroundColor;
                quizContentElement.style.color = currentQuiz.theme.textColor;
                quizContentElement.style.fontFamily = currentQuiz.theme.fontFamily;
                quizContentElement.style.fontSize = `${currentQuiz.theme.fontSize}px`;

                resultsContentElement.style.backgroundColor = currentQuiz.theme.backgroundColor;
                resultsContentElement.style.color = currentQuiz.theme.textColor;
                resultsContentElement.style.fontFamily = currentQuiz.theme.fontFamily;
                resultsContentElement.style.fontSize = `${currentQuiz.theme.fontSize}px`;

                // Also apply to headings within these containers
                // Apply to h1 (quiz title), h3 (question titles), and h4 (question numbers in teacher view)
                quizContentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                    h.style.color = currentQuiz.theme.textColor;
                    h.style.fontFamily = currentQuiz.theme.fontFamily;
                });
                resultsContentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                    h.style.color = currentQuiz.theme.textColor;
                    h.style.fontFamily = currentQuiz.theme.fontFamily;
                });
            } else {
                // Reset to default if no theme is defined (for older quizzes)
                quizContentElement.style.backgroundColor = '';
                quizContentElement.style.color = '';
                quizContentElement.style.fontFamily = '';
                quizContentElement.style.fontSize = '';
                resultsContentElement.style.backgroundColor = '';
                resultsContentElement.style.color = '';
                resultsContentElement.style.fontFamily = '';
                resultsContentElement.style.fontSize = '';
                quizContentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                    h.style.color = '';
                    h.style.fontFamily = '';
                });
                resultsContentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                    h.style.color = '';
                    h.style.fontFamily = '';
                });
            }


            // Show student user ID
            const studentUserIdElement = document.getElementById('studentUserId');
            if (studentUserIdElement) {
                studentUserIdElement.textContent = currentUserId;
            }

            const storedStudentName = sessionStorage.getItem('currentStudentName');

            // Try to load saved progress from localStorage for this specific quiz and student
            let savedProgress = null;
            try {
                const storedData = localStorage.getItem(QUIZ_PROGRESS_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData.quizId === decodedQuizId && parsedData.studentId === currentUserId) {
                        savedProgress = parsedData;
                    } else {
                        // Clear stale progress if it's for a different quiz/student
                        localStorage.removeItem(QUIZ_PROGRESS_STORAGE_KEY);
                    }
                }
            } catch (e) {
                console.error("خطأ في تحميل تقدم الكويز من التخزين المحلي:", e);
                localStorage.removeItem(QUIZ_PROGRESS_STORAGE_KEY); // Clear corrupted data
            }

            // Check if there are already submitted results for this student on this quiz
            // If so, automatically show them their results.
            try {
                const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                const qResults = query(resultsRef,
                    where("quizId", "==", decodedQuizId),
                    where("studentId", "==", currentUserId),
                    where("teacherId", "==", actualTeacherId || quiz.teacherId) // Use actualTeacherId if found, else quiz.teacherId
                );
                const querySnapshot = await getDocs(qResults);
                if (!querySnapshot.empty) {
                    // Sort results by submission time and show the latest
                    const latestResult = querySnapshot.docs
                        .map(doc => doc.data())
                        .sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt))
                        .pop();
                    
                    // Only display results if the quiz settings allow it, otherwise show a message.
                    if (currentQuiz.showResultsToStudents) {
                        window.displayInlineResults(latestResult, quiz);
                    } else {
                        // If results are not to be shown, show a success message and then redirect to student info or a general page.
                        window.showMessageBox(translations[currentLang].answers_submitted_success + '\n' + translations[currentLang].results_not_shown_message);
                        // Hide quiz content and show student info form (or redirect to home/login)
                        document.getElementById('quizContent').classList.add('hidden');
                        document.getElementById('studentInfoForm').classList.remove('hidden');
                        document.getElementById('studentName').value = storedStudentName || ''; // Clear or pre-fill student name
                    }
                    return; // Stop here, either show results or success message
                }
            } catch (e) {
                console.error("خطأ في التحقق من نتائج الكويز السابقة:", e);
                // Continue to show quiz if check fails
            }


            if (storedStudentName) {
                studentAnswers.studentName = storedStudentName;
                document.getElementById('studentInfoForm').classList.add('hidden');
                document.getElementById('quizContent').classList.remove('hidden');
                document.getElementById('studentName').value = storedStudentName; // Pre-fill the input
            } else {
                document.getElementById('studentInfoForm').classList.remove('hidden');
                document.getElementById('quizContent').classList.add('hidden');
            }

            const quizHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${quiz.title}</h1>
                    <p class="text-gray-600 text-lg">${quiz.description}</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                        <i class="fas fa-info-circle ml-2"></i>
                        ${translations[currentLang].total_questions_count}: ${quiz.questions.length}
                    </div>
                </div>

                <form id="studentQuizForm">
                    ${quiz.questions.map((question, index) => {
                        let questionHTML = `
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">
                                        ${index + 1}
                                    </span>
                                    ${question.text}
                                </h3>
                                ${question.imageUrl ? `<img src="${question.imageUrl}" class="mt-2 mb-4 rounded-lg max-w-full h-auto" alt="${translations[currentLang].image_question_alt}">` : ''}
                        `;

                        // Retrieve saved answer for this question
                        const savedAnswer = savedProgress?.answers?.[question.id]; // Can be undefined or null

                        if (question.type === 'multiple') {
                            questionHTML += `
                                <div class="space-y-3">
                                    ${question.options.map((option, optionIndex) => `
                                        <label class="flex items-center p-4 rounded-xl shadow-sm border-2 transition-all duration-200 ease-in-out cursor-pointer 
                                            ${savedAnswer !== undefined && savedAnswer !== null && parseInt(savedAnswer) === optionIndex ? 'bg-blue-50 border-blue-500 shadow-md' : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-md'}">
                                            <input type="radio" name="question_${question.id}" value="${optionIndex}" class="hidden" onchange="handleOptionSelection(this)">
                                            <div class="custom-radio-outer w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 flex-shrink-0 
                                                ${savedAnswer !== undefined && savedAnswer !== null && parseInt(savedAnswer) === optionIndex ? 'bg-blue-500 border-blue-500' : 'border-gray-400'}">
                                                <div class="custom-radio-inner w-3 h-3 rounded-full bg-white 
                                                    ${savedAnswer !== undefined && savedAnswer !== null && parseInt(savedAnswer) === optionIndex ? 'block' : 'hidden'}"></div>
                                            </div>
                                            <span class="flex-1 text-gray-800">${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            `;
                        } else if (question.type === 'boolean') {
                            questionHTML += `
                                <div class="space-y-3">
                                    <label class="flex items-center p-4 rounded-xl shadow-sm border-2 transition-all duration-200 ease-in-out cursor-pointer 
                                        ${savedAnswer === 'true' ? 'bg-blue-50 border-blue-500 shadow-md' : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-md'}">
                                        <input type="radio" name="question_${question.id}" value="true" class="hidden" onchange="handleOptionSelection(this)">
                                        <div class="custom-radio-outer w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 flex-shrink-0 
                                            ${savedAnswer === 'true' ? 'bg-blue-500 border-blue-500' : 'border-gray-400'}">
                                            <div class="custom-radio-inner w-3 h-3 rounded-full bg-white 
                                                ${savedAnswer === 'true' ? 'block' : 'hidden'}"></div>
                                        </div>
                                        <span class="flex-1">${translations[currentLang].true_text}</span>
                                    </label>
                                    <label class="flex items-center p-4 rounded-xl shadow-sm border-2 transition-all duration-200 ease-in-out cursor-pointer 
                                        ${savedAnswer === 'false' ? 'bg-blue-50 border-blue-500 shadow-md' : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-md'}">
                                        <input type="radio" name="question_${question.id}" value="false" class="hidden" onchange="handleOptionSelection(this)">
                                        <div class="custom-radio-outer w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 flex-shrink-0 
                                            ${savedAnswer === 'false' ? 'bg-blue-500 border-blue-500' : 'border-gray-400'}">
                                            <div class="custom-radio-inner w-3 h-3 rounded-full bg-white 
                                                ${savedAnswer === 'false' ? 'block' : 'hidden'}"></div>
                                        </div>
                                        <span class="flex-1">${translations[currentLang].false_text}</span>
                                    </label>
                                </div>
                            `;
                        } else if (question.type === 'text') {
                            questionHTML += `
                                <input type="text" name="question_${question.id}" 
                                       class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg"
                                       placeholder="${translations[currentLang].enter_correct_answer}" value="${savedAnswer || ''}" oninput="saveQuizProgress()">
                            `;
                        }

                        questionHTML += '</div>';
                        return questionHTML;
                    }).join('')}

                    <div class="text-center mt-8">
                        <button type="button" onclick="submitStudentQuiz()" 
                                class="btn-primary text-white px-8 py-4 rounded-lg font-semibold text-lg transition hover:shadow-lg">
                            <i class="fas fa-paper-plane ml-2"></i>
                            <span data-translate-key="submit_answers_button"></span>
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('quizContent').innerHTML = quizHTML;
            // Apply translations to the dynamically created submit button
            document.getElementById('quizContent').querySelector('[data-translate-key="submit_answers_button"]').textContent = translations[currentLang].submit_answers_button;

            window.showStudentPage();
            // Automatically set studentAnswers from loaded progress if it exists
            if (savedProgress) {
                studentAnswers = { ...studentAnswers, ...savedProgress.answers };
            }

            // Apply theme font and size to question titles (h3) and options (span within labels)
            if (currentQuiz.theme) {
                quizContentElement.querySelectorAll('h3').forEach(h3 => {
                    h3.style.fontFamily = currentQuiz.theme.fontFamily;
                    h3.style.fontSize = `${currentQuiz.theme.fontSize}px`;
                });
                // Target all text elements that are direct children of label within .space-y-3
                quizContentElement.querySelectorAll('.space-y-3 label span').forEach(span => {
                    span.style.fontFamily = currentQuiz.theme.fontFamily;
                    span.style.fontSize = `${currentQuiz.theme.fontSize}px`;
                });
                // Also apply to text input for text questions
                quizContentElement.querySelectorAll('input[type="text"][name^="question_"]').forEach(input => {
                    input.style.fontFamily = currentQuiz.theme.fontFamily;
                    input.style.fontSize = `${currentQuiz.theme.fontSize}px`;
                });
            }
        }

        window.saveQuizProgress = function() {
            if (!currentQuiz || !currentUserId) return;

            const form = document.getElementById('studentQuizForm');
            const formData = new FormData(form);
            const currentAnswers = {};

            currentQuiz.questions.forEach(question => {
                const answer = formData.get(`question_${question.id}`);
                // Only save if an answer exists (not null or empty string for radios/text)
                if (answer !== null && answer !== '') {
                    currentAnswers[question.id] = answer;
                }
            });

            const progressState = {
                quizId: currentQuiz.id,
                studentId: currentUserId,
                answers: currentAnswers,
                timestamp: Date.now()
            };
            localStorage.setItem(QUIZ_PROGRESS_STORAGE_KEY, JSON.stringify(progressState));
        };


        window.startQuiz = function() { // Made global
            const studentName = document.getElementById('studentName').value;
            if (!studentName.trim()) {
                window.showMessageBox(translations[currentLang].enter_student_name);
                return;
            }
            
            studentAnswers.studentName = studentName;
            sessionStorage.setItem('currentStudentName', studentName); // Save student name to sessionStorage
            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('quizContent').classList.remove('hidden');

            // Initial save of progress (empty answers)
            window.saveQuizProgress();
        }
            
        window.submitStudentQuiz = async function() { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox(translations[currentLang].please_wait_auth);
                return;
            }

            const studentName = studentAnswers.studentName;
            if (!studentName) {
                window.showMessageBox(translations[currentLang].error_student_data);
                return;
            }

            const form = document.getElementById('studentQuizForm');
            const formData = new FormData(form);
            
            // Validate that all questions have been answered
            let allAnswered = true;
            currentQuiz.questions.forEach(question => {
                const answer = formData.get(`question_${question.id}`);
                if (!answer || answer.trim() === '') {
                    allAnswered = false;
                }
                studentAnswers[question.id] = answer; // Update studentAnswers with final selections
            });

            if (!allAnswered) {
                window.showMessageBox(translations[currentLang].answer_all_questions);
                return;
            }

            // Calculate the score
            let correctAnswers = 0;
           
            const results = {
                quizId: currentQuiz.id,
                quizTitle: currentQuiz.title,
                studentName: studentName,
                studentId: currentUserId, // Save student's Firebase UID
                teacherId: currentQuiz.teacherId, // Save the teacher's ID from the quiz
                totalQuestions: currentQuiz.questions.length,
                answers: [],
                submittedAt: new Date().toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US') // Localized date
            };

            currentQuiz.questions.forEach(question => {
                const studentAnswer = studentAnswers[question.id];
                let isCorrect = false;

                if (question.type === 'multiple') {
                    isCorrect = parseInt(studentAnswer) === question.correctAnswer;
                } else if (question.type === 'boolean') {
                    isCorrect = (studentAnswer === 'true') === question.correctAnswer;
                } else if (question.type === 'text') {
                    isCorrect = studentAnswer.trim().toLowerCase() === question.correctAnswer.toLowerCase();
                }

                if (isCorrect) correctAnswers++;

                results.answers.push({
                    questionId: question.id,
                    questionText: question.text,
                    correctAnswer: question.correctAnswer,
                    isCorrect: isCorrect,
                    questionType: question.type,
                    options: question.options || null,
                    explanation: question.explanation || null, // Include explanation
                    imageUrl: question.imageUrl || null // Include question image URL for review
                });
            });

            results.correctAnswers = correctAnswers;
            results.score = Math.round((correctAnswers / currentQuiz.questions.length) * 100);

            try {
                // Save results to a public collection accessible by the teacher (via teacherId)
                await addDoc(collection(db, `artifacts/${appId}/public/data/quiz_results`), results);
                
                // Clear quiz progress from localStorage after successful submission
                localStorage.removeItem(QUIZ_PROGRESS_STORAGE_KEY);

                // Now, based on the teacher's setting (showResultsToStudents)
                if (currentQuiz.showResultsToStudents) {
                    window.showMessageBox(translations[currentLang].answers_submitted_success);
                    // Update URL to reflect results page state
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('results', 'true');
                    currentUrl.searchParams.set('studentId', currentUserId);
                    currentUrl.searchParams.set('teacher', currentQuiz.teacherId);
                    window.history.pushState({}, '', currentUrl.toString());
                    // Display results immediately
                    window.displayInlineResults(results, currentQuiz);
                } else {
                    // Do NOT update URL to results page
                    window.showMessageBox(translations[currentLang].answers_submitted_success + '\n' + translations[currentLang].results_not_shown_message);
                    // Hide quiz content and show student info form (or redirect to home/login)
                    document.getElementById('quizContent').classList.add('hidden');
                    document.getElementById('studentInfoForm').classList.remove('hidden');
                    document.getElementById('studentName').value = studentName; // Keep student name
                }

            } catch (e) {
                console.error("خطأ في إرسال نتائج الكويز: ", e);
                window.showMessageBox(translations[currentLang].error_submitting_answers);
            }
        }

        // **** New function to display results directly on the page ****
        window.displayInlineResults = function(results, quiz) {
            // Hide quiz and student info forms, show results page
            document.getElementById('studentInfoForm').classList.add('hidden');
            document.getElementById('quizContent').classList.add('hidden');
            window.showResultsPage();

            // Apply theme to the results content
            const resultsContentElement = document.getElementById('resultsContent');
            if (quiz.theme) {
                resultsContentElement.style.backgroundColor = quiz.theme.backgroundColor;
                resultsContentElement.style.color = quiz.theme.textColor;
                resultsContentElement.style.fontFamily = quiz.theme.fontFamily;
                resultsContentElement.style.fontSize = `${quiz.theme.fontSize}px`;

                 resultsContentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                    h.style.color = quiz.theme.textColor;
                    h.style.fontFamily = quiz.theme.fontFamily;
                });
            } else {
                 // Reset to default if no theme is defined (for older quizzes)
                resultsContentElement.style.backgroundColor = '';
                resultsContentElement.style.color = '';
                resultsContentElement.style.fontFamily = '';
                resultsContentElement.style.fontSize = '';
                 resultsContentElement.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
                    h.style.color = '';
                    h.style.fontFamily = '';
                });
            }


            let resultsHTML = `
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-full ${results.score >= 60 ? 'bg-green-100' : 'bg-red-100'} mb-4">
                        <i class="fas fa-${results.score >= 60 ? 'check' : 'times'} text-3xl ${results.score >= 60 ? 'text-green-500' : 'text-red-500'}"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">${translations[currentLang].quiz_score_title}</h1>
                    <h2 class="text-xl text-gray-600 mb-4">${results.quizTitle}</h2>
                    <div class="bg-gray-100 p-3 rounded-lg inline-block mb-4">
                        <i class="fas fa-user ml-2"></i>
                        ${translations[currentLang].student_name_display} ${results.studentName}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-blue-600">${results.score}%</div>
                            <div class="text-sm text-gray-600">${translations[currentLang].percentage_score}</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600">${results.correctAnswers}</div>
                            <div class="text-sm text-gray-600">${translations[currentLang].correct_answers_count}</div>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-gray-600">${results.totalQuestions}</div>
                            <div class="text-sm text-gray-600">${translations[currentLang].total_questions_count}</div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">${translations[currentLang].review_answers_title}</h3>
                    ${results.answers.map((answer, index) => {
                        // Find the original question from the quiz to get options/details
                        const originalQuestion = quiz.questions.find(q => q.id == answer.questionId);

                        if (!originalQuestion) {
                            return `<div class="text-red-500">${translations[currentLang].error_question_not_found} #${answer.questionId}</div>`;
                        }

                        // Determine the student's answer text and correct answer text for display
                        let studentAnswerDisplay = '';
                        let correctAnswerDisplay = '';

                        if (answer.questionType === 'multiple') {
                            studentAnswerDisplay = originalQuestion.options[parseInt(answer.studentAnswer)];
                            correctAnswerDisplay = originalQuestion.options[originalQuestion.correctAnswer];
                        } else if (answer.questionType === 'boolean') {
                            studentAnswerDisplay = answer.studentAnswer === 'true' ? translations[currentLang].true_text : translations[currentLang].false_text;
                            correctAnswerDisplay = originalQuestion.correctAnswer ? translations[currentLang].true_text : translations[currentLang].false_text;
                        } else if (answer.questionType === 'text') {
                            studentAnswerDisplay = answer.studentAnswer;
                            correctAnswerDisplay = originalQuestion.correctAnswer;
                        }

                        return `
                            <div class="bg-gray-50 p-6 rounded-lg border-r-4 ${answer.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4">
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="text-lg font-semibold text-gray-800">
                                        <span class="bg-gray-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center ml-2 text-sm">
                                            ${index + 1}
                                        </span>
                                        ${answer.questionText}
                                    </h4>
                                    <span class="text-2xl ${answer.isCorrect ? 'text-green-500' : 'text-red-500'}">
                                        <i class="fas fa-${answer.isCorrect ? 'check-circle' : 'times-circle'}"></i>
                                    </span>
                                </div>
                                ${originalQuestion.imageUrl ? `<img src="${originalQuestion.imageUrl}" class="mt-2 mb-4 rounded-lg max-w-full h-auto" alt="${translations[currentLang].image_question_alt}">` : ''}
                                
                                ${answer.questionType === 'multiple' ? `
                                    <div class="space-y-2 mt-4">
                                        ${originalQuestion.options.map((option, optionIndex) => {
                                            let optionClasses = 'p-4 rounded-xl shadow-sm border-2 flex items-center transition-all duration-200 ease-in-out';
                                            let outerRadioClasses = 'w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 flex-shrink-0';
                                            let innerRadioClasses = 'w-3 h-3 rounded-full bg-white';
                                            
                                            const isStudentChoiceOption = (originalQuestion.type === 'multiple' && parseInt(answer.studentAnswer) === optionIndex);
                                            const isCorrectOption = (originalQuestion.type === 'multiple' && originalQuestion.correctAnswer === optionIndex);

                                            if (isStudentChoiceOption) {
                                                if (answer.isCorrect) {
                                                    optionClasses += ' bg-green-100 border-green-500 shadow-md';
                                                    outerRadioClasses += ' bg-green-500 border-green-500';
                                                    innerRadioClasses += ' block';
                                                } else {
                                                    optionClasses += ' bg-red-100 border-red-500 shadow-md';
                                                    outerRadioClasses += ' bg-red-500 border-red-500';
                                                    innerRadioClasses += ' block';
                                                }
                                            } else if (isCorrectOption) { // Correct option but not chosen by student
                                                optionClasses += ' bg-green-50 border-green-300';
                                                outerRadioClasses += ' bg-green-300 border-green-300';
                                                innerRadioClasses += ' block';
                                            } else { // Neither student's choice nor correct
                                                optionClasses += ' bg-white border-gray-200';
                                                outerRadioClasses += ' border-gray-400';
                                                innerRadioClasses += ' hidden';
                                            }

                                            return `
                                                <div class="${optionClasses}">
                                                    <div class="${outerRadioClasses}">
                                                        <div class="${innerRadioClasses}"></div>
                                                    </div>
                                                    <span class="flex-1">${option}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : answer.questionType === 'boolean' ? `
                                    <div class="space-y-2 mt-4">
                                        ${[true, false].map(boolValue => {
                                            const optionText = boolValue ? translations[currentLang].true_text : translations[currentLang].false_text;
                                            let optionClasses = 'p-4 rounded-xl shadow-sm border-2 flex items-center transition-all duration-200 ease-in-out';
                                            let outerRadioClasses = 'w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 flex-shrink-0';
                                            let innerRadioClasses = 'w-3 h-3 rounded-full bg-white';

                                            const isStudentChoiceOption = (answer.studentAnswer === String(boolValue));
                                            const isCorrectOption = (originalQuestion.correctAnswer === boolValue);

                                            if (isStudentChoiceOption) {
                                                if (answer.isCorrect) {
                                                    optionClasses += ' bg-green-100 border-green-500 shadow-md';
                                                    outerRadioClasses += ' bg-green-500 border-green-500';
                                                    innerRadioClasses += ' block';
                                                } else {
                                                    optionClasses += ' bg-red-100 border-red-500 shadow-md';
                                                    outerRadioClasses += ' bg-red-500 border-red-500';
                                                    innerRadioClasses += ' block';
                                                }
                                            } else if (isCorrectOption) {
                                                optionClasses += ' bg-green-50 border-green-300';
                                                outerRadioClasses += ' bg-green-300 border-green-300';
                                                innerRadioClasses += ' block';
                                            } else {
                                                optionClasses += ' bg-white border-gray-200';
                                                outerRadioClasses += ' border-gray-400';
                                                innerRadioClasses += ' hidden';
                                            }
                                            return `
                                                <div class="${optionClasses}">
                                                    <div class="${outerRadioClasses}">
                                                        <div class="${innerRadioClasses}"></div>
                                                    </div>
                                                    <span class="flex-1">${optionText}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white p-3 rounded border">
                                            <div class="text-sm font-medium text-gray-600 mb-1">${translations[currentLang].your_answer}</div>
                                            <div class="text-lg ${answer.isCorrect ? 'text-green-700' : 'text-red-700'}">${studentAnswerDisplay}</div>
                                        </div>
                                        <div class="bg-white p-3 rounded border">
                                            <div class="text-sm font-medium text-gray-600 mb-1">${translations[currentLang].correct_answer}</div>
                                            <div class="text-lg text-green-700">${correctAnswerDisplay}</div>
                                        </div>
                                    </div>
                                `}

                                ${originalQuestion.explanation ? `
                                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mt-4">
                                        <div class="text-sm font-medium text-blue-700 mb-1">${translations[currentLang].explanation_note}</div>
                                        <p class="text-blue-800">${originalQuestion.explanation}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('resultsContent').innerHTML = resultsHTML;
            // The close window button has been removed as per request.

            // Apply theme font and size to question titles (h4 in results) and options (span within div)
            if (quiz.theme) {
                resultsContentElement.querySelectorAll('.mb-6 h3, .mb-6 h4').forEach(heading => { // Target both h3 and h4 in results review
                    heading.style.fontFamily = quiz.theme.fontFamily;
                    heading.style.fontSize = `${quiz.theme.fontSize}px`;
                });
                resultsContentElement.querySelectorAll('.space-y-2 span').forEach(span => { // Adjust selector for options in results
                    span.style.fontFamily = quiz.theme.fontFamily;
                    span.style.fontSize = `${quiz.theme.fontSize}px`;
                });
            }
        };


        window.showResults = async function(quizId, studentIdParam, teacherIdParam) { // Made global
            if (!isAuthReady || !currentUserId) {
                console.log(translations[currentLang].awaiting_auth_results);
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.showResults(quizId, studentIdParam, teacherIdParam);
                        unsubscribe();
                    }
                });
                return;
            }

            let latestResult = null;
            let quiz = null;

            // Decode quizId, studentIdParam, teacherIdParam received from the URL
            const decodedQuizId = decodeURIComponent(quizId);
            const decodedStudentIdParam = decodeURIComponent(studentIdParam);
            const decodedTeacherIdParam = decodeURIComponent(teacherIdParam);


            try {
                // Fetch the specific quiz first to get teacherId and questions
                let foundQuizDoc = null;
                if (decodedTeacherIdParam) {
                    const specificQuizDocRef = doc(db, `artifacts/${appId}/users/${decodedTeacherIdParam}/quizzes`, decodedQuizId);
                    const specificQuizSnap = await getDoc(specificQuizDocRef);
                    if (specificQuizSnap.exists()) {
                        foundQuizDoc = specificQuizSnap;
                    }
                } else {
                     // Fallback: search all teacher quizzes for the quizId (less efficient, but handles direct navigation)
                    const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                    const usersSnapshot = await getDocs(usersCollectionRef);
                    for (const userDoc of usersSnapshot.docs) {
                        const quizzesCollectionRef = collection(db, `artifacts/${appId}/users/${userDoc.id}/quizzes`);
                        const qQuiz = query(quizzesCollectionRef, where("__name__", "==", decodedQuizId));
                        const quizSnapshot = await getDocs(qQuiz);
                        if (!quizSnapshot.empty) {
                            foundQuizDoc = quizSnapshot.docs[0];
                            quiz = { id: foundQuizDoc.id, ...foundQuizDoc.data() };
                            // teacherIdParam = userDoc.id; // Set teacherId if found - this was already done, no need to update original variable
                            break;
                        }
                    }
                }

                if (foundQuizDoc) {
                    quiz = { id: foundQuizDoc.id, ...foundQuizDoc.data() };
                } else {
                     document.getElementById('resultsContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">${translations[currentLang].quiz_not_found}</h2>
                            <p class="text-gray-600">${translations[currentLang].quiz_not_found_desc}</p>
                        </div>
                    `;
                    window.showResultsPage();
                    return;
                }

                // Fetch results for the specific quiz and student
                const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
                const qResults = query(resultsRef, 
                    where("quizId", "==", decodedQuizId),
                    where("studentId", "==", decodedStudentIdParam), // Use decoded studentIdParam from URL
                    where("teacherId", "==", decodedTeacherIdParam) // Use decoded teacherIdParam from URL
                );
                const querySnapshot = await getDocs(qResults);
                const allResultsForStudent = [];
                querySnapshot.forEach((doc) => {
                    allResultsForStudent.push({ id: doc.id, ...doc.data() });
                });

                if (allResultsForStudent.length === 0) {
                    document.getElementById('resultsContent').innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-chart-bar text-gray-400 text-6xl mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">${translations[currentLang].no_results_yet}</h2>
                            <p class="text-gray-600">${translations[currentLang].no_results_found}</p>
                        </div>
                    `;
                    window.showResultsPage();
                    return;
                }

                latestResult = allResultsForStudent[allResultsForStudent.length - 1]; // Get the latest attempt

                // Call the new displayInlineResults function to render the results
                window.displayInlineResults(latestResult, quiz);

            } catch (e) {
                console.error("خطأ في عرض النتائج:", e);
                document.getElementById('resultsContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${translations[currentLang].error_loading_results}</h2>
                        <p class="text-600">${translations[currentLang].error_loading_results_desc}</p>
                    </div>
                `;
                window.showResultsPage();
            }
        }

        // --- Teacher View Results ---
        window.viewQuizResultsForTeacher = async function(quizId) { // Made global
            if (!isAuthReady || !currentUserId) {
                window.showMessageBox(translations[currentLang].awaiting_auth_teacher_results);
                return;
            }

            let quizTitle = translations[currentLang].quiz_results_title; // Default title
            // Decode quizId received from URL before using it in Firestore
            const decodedQuizId = decodeURIComponent(quizId);

            try {
                const quizDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/quizzes`, decodedQuizId);
                const quizDocSnap = await getDoc(quizDocRef);
                if (quizDocSnap.exists()) {
                    quizTitle = quizDocSnap.data().title;
                }
            } catch (e) {
                console.error(translations[currentLang].error_fetching_quiz_title, e);
            }

            // If there's an existing listener, unsubscribe it to prevent multiple listeners
            if (unsubscribeTeacherResults) {
                unsubscribeTeacherResults();
            }

            const resultsRef = collection(db, `artifacts/${appId}/public/data/quiz_results`);
            const q = query(resultsRef, 
                where("quizId", "==", decodedQuizId),
                where("teacherId", "==", currentUserId) // Filter results by teacherId
            );

            // Use onSnapshot for real-time updates
            unsubscribeTeacherResults = onSnapshot(q, (querySnapshot) => {
                const allResults = [];
                querySnapshot.forEach((doc) => {
                    allResults.push({ id: doc.id, ...doc.data() });
                });

                if (allResults.length === 0) {
                    window.showMessageBox(translations[currentLang].no_results_yet);
                    // Close the modal if it's open and there are no results
                    closeStatsModal();
                    return;
                }

                // General statistics
                const totalAttempts = allResults.length;
                const avgScore = Math.round(allResults.reduce((sum, result) => sum + result.score, 0) / totalAttempts);
                const passCount = allResults.filter(result => result.score >= 60).length;

                // Build the HTML for the stats modal
                const statsModalHTML = `
                    <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeStatsModal(event)">
                        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4" onclick="event.stopPropagation()">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-800">
                                        <i class="fas fa-chart-line text-blue-500 ml-2"></i>
                                        ${translations[currentLang].quiz_stats_title} ${quizTitle}
                                    </h2>
                                    <button onclick="closeStatsModal()" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-blue-600">${totalAttempts}</div>
                                        <div class="text-sm text-gray-600">${translations[currentLang].total_attempts}</div>
                                    </div>
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-green-600">${avgScore}%</div>
                                        <div class="text-sm text-gray-600">${translations[currentLang].average_score}</div>
                                    </div>
                                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-purple-600">${passCount}</div>
                                        <div class="text-sm text-gray-600">${translations[currentLang].passed_students}</div>
                                    </div>
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                                        <div class="text-2xl font-bold text-orange-600">${totalAttempts - passCount}</div>
                                        <div class="text-sm text-gray-600">${translations[currentLang].failed_students}</div>
                                    </div>
                                </div>

                                <h3 class="text-xl font-bold text-gray-800 mb-4">${translations[currentLang].all_attempts}</h3>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${allResults.map((result, index) => `
                                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <div class="font-semibold text-gray-800">${result.studentName || translations[currentLang].student_name_display}</div>
                                                    <div class="text-sm text-gray-600">${translations[currentLang].student_id_display} ${result.studentId || 'N/A'}</div>
                                                    <div class="text-sm text-gray-600">${result.submittedAt}</div>
                                                </div>
                                                <div class="text-left">
                                                    <div class="text-2xl font-bold ${result.score >= 60 ? 'text-green-600' : 'text-red-600'}">${result.score}%</div>
                                                    <div class="text-sm text-gray-600">${result.correctAnswers}/${result.totalQuestions}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // If the modal already exists, update its content; otherwise, create it
                const existingModal = document.getElementById('statsModal');
                if (existingModal) {
                    existingModal.outerHTML = statsModalHTML; // Replace with updated content
                } else {
                    document.body.insertAdjacentHTML('beforeend', statsModalHTML);
                }

            }, (error) => {
                console.error("خطأ في تحميل جميع نتائج الكويز للمعلم (onSnapshot):", error);
                window.showMessageBox(translations[currentLang].error_loading_teacher_results);
            });
        }

        window.closeStatsModal = function(event) { // Made global
            // Check if the click was inside the modal content to prevent closing when interacting with modal
            if (event && event.target.closest('.bg-white')) {
                return;
            }
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.remove();
                // If there's an active listener, unsubscribe it when the modal is closed
                if (unsubscribeTeacherResults) {
                    unsubscribeTeacherResults();
                    unsubscribeTeacherResults = null; // Clear the reference
                }
            }
        }


        // --- Utility/UI Functions ---
        window.showStudentPage = function() { // Made global
            document.getElementById('loginPage').classList.add('hidden'); // Hide login page
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.remove('hidden');
            document.getElementById('resultsPage').classList.add('hidden');
            renderContent(); // Re-render content for student page
        }

        window.showResultsPage = function() { // Made global
            document.getElementById('loginPage').classList.add('hidden'); // Hide login page
            document.getElementById('teacherPage').classList.add('hidden');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('resultsPage').classList.remove('hidden');
            renderContent(); // Re-render content for results page
        }

        // Function to display a custom message box instead of alert
        window.showMessageBox = function(message) { // Made global
            const modalHTML = `
                <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <button onclick="document.getElementById('customAlertModal').remove()" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition">${translations[currentLang].ok_button || 'OK'}</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Function to display a custom confirmation box instead of confirm
        window.showConfirmBox = function(message, onConfirmCallback) { // Made global
            const modalHTML = `
                <div id="customConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <p class="text-gray-800 text-lg mb-4">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition">${translations[currentLang].yes_button || 'Yes'}</button>
                            <button id="confirmNoBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">${translations[currentLang].cancel_button || 'Cancel'}</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('confirmYesBtn').onclick = () => {
                document.getElementById('customConfirmModal').remove();
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
            };
            document.getElementById('confirmNoBtn').onclick = () => {
                document.getElementById('customConfirmModal').remove();
            };
        }

        // Add 'ok_button', 'yes_button', 'cancel_button' to translations
        translations.ar.ok_button = 'حسناً';
        translations.ar.yes_button = 'نعم';
        translations.ar.cancel_button = 'إلغاء';
        translations.en.ok_button = 'OK';
        translations.en.yes_button = 'Yes';
        translations.en.cancel_button = 'Cancel';

        // Add dynamic button texts for saved quizzes section
        translations.ar.copy_link_button_dynamic = 'نسخ الرابط';
        translations.ar.results_button_dynamic = 'النتائج';
        translations.ar.edit_button_dynamic = 'تعديل';
        translations.ar.delete_quiz_dynamic = 'حذف'; // Changed key name for delete button
        translations.en.copy_link_button_dynamic = 'Copy Link';
        translations.en.results_button_dynamic = 'Results';
        translations.en.edit_button_dynamic = 'Edit';
        translations.en.delete_quiz_dynamic = 'Delete'; // Changed key name for delete button


    </script>
</body>
</html>
